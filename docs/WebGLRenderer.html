<!DOCTYPE html>  <html> <head>   <title>WebGLRenderer.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Three.html">                 Three.js               </a>                                           <a class="source" href="Camera.html">                 Camera.js               </a>                                           <a class="source" href="OrthographicCamera.html">                 OrthographicCamera.js               </a>                                           <a class="source" href="PerspectiveCamera.html">                 PerspectiveCamera.js               </a>                                           <a class="source" href="Clock.html">                 Clock.js               </a>                                           <a class="source" href="Color.html">                 Color.js               </a>                                           <a class="source" href="Edge.html">                 Edge.js               </a>                                           <a class="source" href="Face3.html">                 Face3.js               </a>                                           <a class="source" href="Face4.html">                 Face4.js               </a>                                           <a class="source" href="Geometry.html">                 Geometry.js               </a>                                           <a class="source" href="Math.html">                 Math.js               </a>                                           <a class="source" href="Matrix3.html">                 Matrix3.js               </a>                                           <a class="source" href="Matrix4.html">                 Matrix4.js               </a>                                           <a class="source" href="Object3D.html">                 Object3D.js               </a>                                           <a class="source" href="Projector.html">                 Projector.js               </a>                                           <a class="source" href="Quaternion.html">                 Quaternion.js               </a>                                           <a class="source" href="Ray.html">                 Ray.js               </a>                                           <a class="source" href="Rectangle.html">                 Rectangle.js               </a>                                           <a class="source" href="Spline.html">                 Spline.js               </a>                                           <a class="source" href="UV.html">                 UV.js               </a>                                           <a class="source" href="Vector2.html">                 Vector2.js               </a>                                           <a class="source" href="Vector3.html">                 Vector3.js               </a>                                           <a class="source" href="Vector4.html">                 Vector4.js               </a>                                           <a class="source" href="Vertex.html">                 Vertex.js               </a>                                           <a class="source" href="ColorUtils.html">                 ColorUtils.js               </a>                                           <a class="source" href="GeometryUtils.html">                 GeometryUtils.js               </a>                                           <a class="source" href="ImageUtils.html">                 ImageUtils.js               </a>                                           <a class="source" href="SceneUtils.html">                 SceneUtils.js               </a>                                           <a class="source" href="ShaderUtils.html">                 ShaderUtils.js               </a>                                           <a class="source" href="Animation.html">                 Animation.js               </a>                                           <a class="source" href="AnimationHandler.html">                 AnimationHandler.js               </a>                                           <a class="source" href="AnimationMorphTarget.html">                 AnimationMorphTarget.js               </a>                                           <a class="source" href="CombinedCamera.html">                 CombinedCamera.js               </a>                                           <a class="source" href="CubeCamera.html">                 CubeCamera.js               </a>                                           <a class="source" href="FirstPersonCamera.html">                 FirstPersonCamera.js               </a>                                           <a class="source" href="FlyCamera.html">                 FlyCamera.js               </a>                                           <a class="source" href="PathCamera.html">                 PathCamera.js               </a>                                           <a class="source" href="RollCamera.html">                 RollCamera.js               </a>                                           <a class="source" href="TrackballCamera.html">                 TrackballCamera.js               </a>                                           <a class="source" href="FirstPersonControls.html">                 FirstPersonControls.js               </a>                                           <a class="source" href="FlyControls.html">                 FlyControls.js               </a>                                           <a class="source" href="PathControls.html">                 PathControls.js               </a>                                           <a class="source" href="RollControls.html">                 RollControls.js               </a>                                           <a class="source" href="TrackballControls.html">                 TrackballControls.js               </a>                                           <a class="source" href="Curve.html">                 Curve.js               </a>                                           <a class="source" href="CurvePath.html">                 CurvePath.js               </a>                                           <a class="source" href="Path.html">                 Path.js               </a>                                           <a class="source" href="Shape.html">                 Shape.js               </a>                                           <a class="source" href="TextPath.html">                 TextPath.js               </a>                                           <a class="source" href="CubeGeometry.html">                 CubeGeometry.js               </a>                                           <a class="source" href="CylinderGeometry.html">                 CylinderGeometry.js               </a>                                           <a class="source" href="ExtrudeGeometry.html">                 ExtrudeGeometry.js               </a>                                           <a class="source" href="IcosahedronGeometry.html">                 IcosahedronGeometry.js               </a>                                           <a class="source" href="LatheGeometry.html">                 LatheGeometry.js               </a>                                           <a class="source" href="OctahedronGeometry.html">                 OctahedronGeometry.js               </a>                                           <a class="source" href="PlaneGeometry.html">                 PlaneGeometry.js               </a>                                           <a class="source" href="SphereGeometry.html">                 SphereGeometry.js               </a>                                           <a class="source" href="TextGeometry.html">                 TextGeometry.js               </a>                                           <a class="source" href="TorusGeometry.html">                 TorusGeometry.js               </a>                                           <a class="source" href="TorusKnotGeometry.html">                 TorusKnotGeometry.js               </a>                                           <a class="source" href="BinaryLoader.html">                 BinaryLoader.js               </a>                                           <a class="source" href="ColladaLoader.html">                 ColladaLoader.js               </a>                                           <a class="source" href="JSONLoader.html">                 JSONLoader.js               </a>                                           <a class="source" href="Loader.html">                 Loader.js               </a>                                           <a class="source" href="SceneLoader.html">                 SceneLoader.js               </a>                                           <a class="source" href="UTF8Loader.html">                 UTF8Loader.js               </a>                                           <a class="source" href="SubdivisionModifier.html">                 SubdivisionModifier.js               </a>                                           <a class="source" href="Axes.html">                 Axes.js               </a>                                           <a class="source" href="MarchingCubes.html">                 MarchingCubes.js               </a>                                           <a class="source" href="AnaglyphWebGLRenderer.html">                 AnaglyphWebGLRenderer.js               </a>                                           <a class="source" href="CrosseyedWebGLRenderer.html">                 CrosseyedWebGLRenderer.js               </a>                                           <a class="source" href="ParallaxBarrierWebGLRenderer.html">                 ParallaxBarrierWebGLRenderer.js               </a>                                           <a class="source" href="AmbientLight.html">                 AmbientLight.js               </a>                                           <a class="source" href="DirectionalLight.html">                 DirectionalLight.js               </a>                                           <a class="source" href="Light.html">                 Light.js               </a>                                           <a class="source" href="PointLight.html">                 PointLight.js               </a>                                           <a class="source" href="SpotLight.html">                 SpotLight.js               </a>                                           <a class="source" href="LineBasicMaterial.html">                 LineBasicMaterial.js               </a>                                           <a class="source" href="Material.html">                 Material.js               </a>                                           <a class="source" href="MeshBasicMaterial.html">                 MeshBasicMaterial.js               </a>                                           <a class="source" href="MeshDepthMaterial.html">                 MeshDepthMaterial.js               </a>                                           <a class="source" href="MeshFaceMaterial.html">                 MeshFaceMaterial.js               </a>                                           <a class="source" href="MeshLambertMaterial.html">                 MeshLambertMaterial.js               </a>                                           <a class="source" href="MeshNormalMaterial.html">                 MeshNormalMaterial.js               </a>                                           <a class="source" href="MeshPhongMaterial.html">                 MeshPhongMaterial.js               </a>                                           <a class="source" href="MeshShaderMaterial.html">                 MeshShaderMaterial.js               </a>                                           <a class="source" href="ParticleBasicMaterial.html">                 ParticleBasicMaterial.js               </a>                                           <a class="source" href="ParticleCanvasMaterial.html">                 ParticleCanvasMaterial.js               </a>                                           <a class="source" href="ParticleDOMMaterial.html">                 ParticleDOMMaterial.js               </a>                                           <a class="source" href="ShaderMaterial.html">                 ShaderMaterial.js               </a>                                           <a class="source" href="Bone.html">                 Bone.js               </a>                                           <a class="source" href="LOD.html">                 LOD.js               </a>                                           <a class="source" href="Line.html">                 Line.js               </a>                                           <a class="source" href="Mesh.html">                 Mesh.js               </a>                                           <a class="source" href="MorphAnimMesh.html">                 MorphAnimMesh.js               </a>                                           <a class="source" href="Particle.html">                 Particle.js               </a>                                           <a class="source" href="ParticleSystem.html">                 ParticleSystem.js               </a>                                           <a class="source" href="Ribbon.html">                 Ribbon.js               </a>                                           <a class="source" href="SkinnedMesh.html">                 SkinnedMesh.js               </a>                                           <a class="source" href="Sprite.html">                 Sprite.js               </a>                                           <a class="source" href="CanvasRenderer.html">                 CanvasRenderer.js               </a>                                           <a class="source" href="DOMRenderer.html">                 DOMRenderer.js               </a>                                           <a class="source" href="SVGRenderer.html">                 SVGRenderer.js               </a>                                           <a class="source" href="WebGLRenderTarget.html">                 WebGLRenderTarget.js               </a>                                           <a class="source" href="WebGLRenderTargetCube.html">                 WebGLRenderTargetCube.js               </a>                                           <a class="source" href="WebGLRenderer.html">                 WebGLRenderer.js               </a>                                           <a class="source" href="WebGLShaders.html">                 WebGLShaders.js               </a>                                           <a class="source" href="RenderableFace3.html">                 RenderableFace3.js               </a>                                           <a class="source" href="RenderableFace4.html">                 RenderableFace4.js               </a>                                           <a class="source" href="RenderableLine.html">                 RenderableLine.js               </a>                                           <a class="source" href="RenderableObject.html">                 RenderableObject.js               </a>                                           <a class="source" href="RenderableParticle.html">                 RenderableParticle.js               </a>                                           <a class="source" href="RenderableVertex.html">                 RenderableVertex.js               </a>                                           <a class="source" href="Fog.html">                 Fog.js               </a>                                           <a class="source" href="FogExp2.html">                 FogExp2.js               </a>                                           <a class="source" href="Scene.html">                 Scene.js               </a>                                           <a class="source" href="DataTexture.html">                 DataTexture.js               </a>                                           <a class="source" href="Texture.html">                 Texture.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               WebGLRenderer.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @author supereggbert / http://www.paulbrunt.co.uk/</span>
<span class="cm"> * @author mrdoob / http://mrdoob.com/</span>
<span class="cm"> * @author alteredq / http://alteredqualia.com/</span>
<span class="cm"> * @author szimek / https://github.com/szimek/</span>
<span class="cm"> */</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">parameters</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>constructor parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="nx">parameters</span> <span class="o">||</span> <span class="p">{},</span>

	<span class="nx">_canvas</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="s1">&#39;canvas&#39;</span> <span class="p">),</span>

	<span class="nx">_precision</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">precision</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">precision</span> <span class="o">:</span> <span class="s1">&#39;highp&#39;</span><span class="p">,</span>
	<span class="nx">_antialias</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">antialias</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">antialias</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">_stencil</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">stencil</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">stencil</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="nx">_preserveDrawingBuffer</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">preserveDrawingBuffer</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">preserveDrawingBuffer</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

	<span class="nx">_clearColor</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">clearColor</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">clearColor</span> <span class="p">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span> <span class="mh">0x000000</span> <span class="p">),</span>
	<span class="nx">_clearAlpha</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">clearAlpha</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">clearAlpha</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

	<span class="nx">_maxLights</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxLights</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxLights</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>public properties</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">domElement</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>clearing</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">autoClear</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">autoClearColor</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">autoClearDepth</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">autoClearStencil</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>scene graph</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">sortObjects</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">autoUpdateObjects</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">autoUpdateScene</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>physically based shading</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">gammaOutput</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">physicallyBasedShading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>shadow map</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapBias</span> <span class="o">=</span> <span class="mf">0.0039</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapDarkness</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapWidth</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapHeight</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">shadowCameraNear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowCameraFar</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowCameraFov</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMap</span> <span class="o">=</span> <span class="p">[];</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapAutoUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shadowMapSoft</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>morphs</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">maxMorphTargets</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>info</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">info</span> <span class="o">=</span> <span class="p">{</span>

		<span class="nx">memory</span><span class="o">:</span> <span class="p">{</span>

			<span class="nx">programs</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">geometries</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">textures</span><span class="o">:</span> <span class="mi">0</span>

		<span class="p">},</span>

		<span class="nx">render</span><span class="o">:</span> <span class="p">{</span>

			<span class="nx">calls</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">vertices</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">faces</span><span class="o">:</span> <span class="mi">0</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>internal properties</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>

	<span class="nx">_gl</span><span class="p">,</span>

	<span class="nx">_programs</span> <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>internal state cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_currentProgram</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_currentFramebuffer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_currentMaterialId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="nx">_currentGeometryGroupHash</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_geometryGroupCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>GL state cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_oldDoubleSided</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldFlipSided</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldBlending</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldDepthTest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldDepthWrite</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldPolygonOffset</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldPolygonOffsetFactor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldPolygonOffsetUnits</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">_oldLineWidth</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>

	<span class="nx">_viewportX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nx">_viewportY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nx">_viewportWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nx">_viewportHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>frustum cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_frustum</span> <span class="o">=</span> <span class="p">[</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span>
		<span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">()</span>
	 <span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>camera matrices cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_projScreenMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">(),</span>
	<span class="nx">_projectionMatrixArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="p">),</span>
	<span class="nx">_viewMatrixArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="p">),</span>

	<span class="nx">_vector3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector4</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>light arrays cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_lights</span> <span class="o">=</span> <span class="p">{</span>

		<span class="nx">ambient</span><span class="o">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">],</span>
		<span class="nx">directional</span><span class="o">:</span> <span class="p">{</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">colors</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">positions</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span> <span class="p">},</span>
		<span class="nx">point</span><span class="o">:</span> <span class="p">{</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">colors</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">positions</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">distances</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span> <span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>shadow maps</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">_cameraLight</span><span class="p">,</span> <span class="nx">_shadowMatrix</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="kd">var</span> <span class="nx">_depthMaterial</span><span class="p">,</span> <span class="nx">_depthMaterialMorph</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>sprites</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">_sprite</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kd">var</span> <span class="nx">_spriteAttributesEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>initialize</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_gl</span> <span class="o">=</span> <span class="nx">initGL</span><span class="p">();</span>

	<span class="nx">setDefaultGLState</span><span class="p">();</span>

	<span class="nx">initSprites</span><span class="p">();</span>
	<span class="nx">initShadowmaps</span><span class="p">();</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">;</span>

	<span class="kd">var</span> <span class="nx">_supportsVertexTextures</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">maxVertexTextures</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>API</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">getContext</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">_gl</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">supportsVertexTextures</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">_supportsVertexTextures</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">setSize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
		<span class="nx">_canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">setViewport</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">height</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">setViewport</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_viewportX</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
		<span class="nx">_viewportY</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>

		<span class="nx">_viewportWidth</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
		<span class="nx">_viewportHeight</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">viewport</span><span class="p">(</span> <span class="nx">_viewportX</span><span class="p">,</span> <span class="nx">_viewportY</span><span class="p">,</span> <span class="nx">_viewportWidth</span><span class="p">,</span> <span class="nx">_viewportHeight</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">setScissor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">scissor</span><span class="p">(</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">enableScissorTest</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">enable</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">enable</span> <span class="o">?</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span> <span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Clearing</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">setClearColorHex</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">hex</span><span class="p">,</span> <span class="nx">alpha</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_clearColor</span><span class="p">.</span><span class="nx">setHex</span><span class="p">(</span> <span class="nx">hex</span> <span class="p">);</span>
		<span class="nx">_clearAlpha</span> <span class="o">=</span> <span class="nx">alpha</span><span class="p">;</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">_clearAlpha</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">setClearColor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">alpha</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_clearColor</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">color</span> <span class="p">);</span>
		<span class="nx">_clearAlpha</span> <span class="o">=</span> <span class="nx">alpha</span><span class="p">;</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">_clearAlpha</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">getClearColor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">_clearColor</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">getClearAlpha</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">_clearAlpha</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">stencil</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">color</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">color</span> <span class="p">)</span> <span class="nx">bits</span> <span class="o">|=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">COLOR_BUFFER_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">depth</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">depth</span> <span class="p">)</span> <span class="nx">bits</span> <span class="o">|=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_BUFFER_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">stencil</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">stencil</span> <span class="p">)</span> <span class="nx">bits</span> <span class="o">|=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">STENCIL_BUFFER_BIT</span><span class="p">;</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span> <span class="nx">bits</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">clearTarget</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">stencil</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">setRenderTarget</span><span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">stencil</span> <span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Deallocation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">deallocateObject</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

		<span class="nx">object</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span><span class="p">;</span>

		<span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_normalMatrixArray</span><span class="p">;</span>
		<span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span><span class="p">;</span>
		<span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">deleteMeshBuffers</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">g</span> <span class="p">]</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">deleteRibbonBuffers</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">deleteLineBuffers</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">deleteParticleBuffers</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">deallocateTexture</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">texture</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

		<span class="nx">texture</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteTexture</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">textures</span> <span class="o">--</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Rendering</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">updateShadowMap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">renderShadowMap</span><span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Internal functions</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Buffer allocation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">createParticleBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">++</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">createLineBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">++</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">createRibbonBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">++</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">createMeshBuffers</span> <span class="p">(</span> <span class="nx">geometryGroup</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglTangentBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUVBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUV2Buffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexABuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexBBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinIndicesBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinWeightsBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="kd">var</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">ml</span><span class="p">;</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ml</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span><span class="p">;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">ml</span><span class="p">;</span> <span class="nx">m</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">()</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">++</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Buffer deallocation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">deleteParticleBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">--</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">deleteLineBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">--</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">deleteRibbonBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">--</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">deleteMeshBuffers</span> <span class="p">(</span> <span class="nx">geometryGroup</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglTangentBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUVBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUV2Buffer</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexABuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexBBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinIndicesBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinWeightsBuffer</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineBuffer</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ml</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span><span class="p">;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">ml</span><span class="p">;</span> <span class="nx">m</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">[</span> <span class="nx">m</span> <span class="p">]</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">deleteBuffer</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">[</span> <span class="nx">id</span> <span class="p">].</span><span class="nx">buffer</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">--</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Buffer initialization</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">initCustomAttributes</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">nvertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="kd">var</span> <span class="nx">material</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

				<span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">];</span>

				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">__webglInitialized</span> <span class="o">||</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">createUniqueBuffers</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">__webglInitialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

					<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="c1">// &quot;f&quot; and &quot;i&quot;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v2&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v3&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v4&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span>  <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="nx">size</span> <span class="p">);</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
					<span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">belongsToAttribute</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">attribute</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">initParticleBuffers</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">nvertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__sortArray</span> <span class="o">=</span> <span class="p">[];</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglParticleCount</span> <span class="o">=</span> <span class="nx">nvertices</span><span class="p">;</span>

		<span class="nx">initCustomAttributes</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">initLineBuffers</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">nvertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglLineCount</span> <span class="o">=</span> <span class="nx">nvertices</span><span class="p">;</span>

		<span class="nx">initCustomAttributes</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">initRibbonBuffers</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">nvertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexCount</span> <span class="o">=</span> <span class="nx">nvertices</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">initMeshBuffers</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">,</span>
			<span class="nx">faces3</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">faces3</span><span class="p">,</span>
			<span class="nx">faces4</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">faces4</span><span class="p">,</span>

			<span class="nx">nvertices</span> <span class="o">=</span> <span class="nx">faces3</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="nx">faces4</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="nx">ntris</span>     <span class="o">=</span> <span class="nx">faces3</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">faces4</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			<span class="nx">nlines</span>    <span class="o">=</span> <span class="nx">faces3</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="nx">faces4</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>

			<span class="nx">material</span> <span class="o">=</span> <span class="nx">getBufferMaterial</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">geometryGroup</span> <span class="p">),</span>

			<span class="nx">uvType</span> <span class="o">=</span> <span class="nx">bufferGuessUVType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">),</span>
			<span class="nx">normalType</span> <span class="o">=</span> <span class="nx">bufferGuessNormalType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">),</span>
			<span class="nx">vertexColorType</span> <span class="o">=</span> <span class="nx">bufferGuessVertexColorType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>console.log( "uvType", uvType, "normalType", normalType, "vertexColorType", vertexColorType, object, geometryGroup, material );</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__vertexArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">normalType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__normalArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">hasTangents</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__tangentArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">vertexColorType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__colorArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">uvType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceUvs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceVertexUvs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uvArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceUvs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceVertexUvs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uv2Array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">skinWeights</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">skinIndices</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexAArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">);</span>
			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexBArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">);</span>
			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinIndexArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">);</span>
			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinWeightArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__faceArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span> <span class="nx">ntris</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__lineArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span> <span class="nx">nlines</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__morphTargetsArrays</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ml</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">numMorphTargets</span><span class="p">;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">ml</span><span class="p">;</span> <span class="nx">m</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__morphTargetsArrays</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceCount</span> <span class="o">=</span> <span class="nx">ntris</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineCount</span> <span class="o">=</span> <span class="nx">nlines</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>custom attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Do a shallow copy of the attribute object so different geometryGroup chunks use different
attribute buffers which are correctly indexed in the setMeshBuffers function</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">originalAttribute</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">];</span>

				<span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="p">{};</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">originalAttribute</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">attribute</span><span class="p">[</span> <span class="nx">property</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">originalAttribute</span><span class="p">[</span> <span class="nx">property</span> <span class="p">];</span>

				<span class="p">}</span>

				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">__webglInitialized</span> <span class="o">||</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">createUniqueBuffers</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">__webglInitialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

					<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="c1">// &quot;f&quot; and &quot;i&quot;</span>

					<span class="k">if</span><span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v2&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v3&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v4&quot;</span> <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span>  <span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">nvertices</span> <span class="o">*</span> <span class="nx">size</span> <span class="p">);</span>

					<span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
					<span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">belongsToAttribute</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>

					<span class="nx">originalAttribute</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="nx">attribute</span><span class="p">.</span><span class="nx">__original</span> <span class="o">=</span> <span class="nx">originalAttribute</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">attribute</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__inittedArrays</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">getBufferMaterial</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">geometryGroup</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshFaceMaterial</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">materialIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">materials</span><span class="p">[</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">materialIndex</span> <span class="p">];</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">materialNeedsSmoothNormals</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">material</span> <span class="o">&amp;&amp;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">shading</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">shading</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SmoothShading</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">bufferGuessNormalType</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>only MeshBasicMaterial and MeshDepthMaterial don't need normals</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshDepthMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">materialNeedsSmoothNormals</span><span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SmoothShading</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">return</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FlatShading</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">bufferGuessVertexColorType</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">vertexColors</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="nx">material</span><span class="p">.</span><span class="nx">vertexColors</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">bufferGuessUVType</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>material must use some texture to require uvs</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span> <span class="o">||</span> <span class="nx">material</span><span class="p">.</span><span class="nx">lightMap</span> <span class="o">||</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Buffer setting</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">setParticleBuffers</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">hint</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">vertex</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span>

		<span class="nx">vertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">,</span>
		<span class="nx">vl</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>

		<span class="nx">colors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>
		<span class="nx">cl</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>

		<span class="nx">vertexArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span><span class="p">,</span>
		<span class="nx">colorArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span><span class="p">,</span>

		<span class="nx">sortArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__sortArray</span><span class="p">,</span>

		<span class="nx">dirtyVertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span><span class="p">,</span>
		<span class="nx">dirtyElements</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyElements</span><span class="p">,</span>
		<span class="nx">dirtyColors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span><span class="p">,</span>

		<span class="nx">customAttributes</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">,</span>
		<span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span>
		<span class="nx">a</span><span class="p">,</span> <span class="nx">ca</span><span class="p">,</span> <span class="nx">cal</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span>
		<span class="nx">customAttribute</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sortParticles</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_projScreenMatrix</span><span class="p">.</span><span class="nx">multiplySelf</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">vl</span><span class="p">;</span> <span class="nx">v</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">vertex</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">v</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">_vector3</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">vertex</span> <span class="p">);</span>
				<span class="nx">_projScreenMatrix</span><span class="p">.</span><span class="nx">multiplyVector3</span><span class="p">(</span> <span class="nx">_vector3</span> <span class="p">);</span>

				<span class="nx">sortArray</span><span class="p">[</span> <span class="nx">v</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">_vector3</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">v</span> <span class="p">];</span>

			<span class="p">}</span>

			<span class="nx">sortArray</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">b</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">-</span> <span class="nx">a</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span> <span class="p">}</span> <span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">vl</span><span class="p">;</span> <span class="nx">v</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">vertex</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">sortArray</span><span class="p">[</span><span class="nx">v</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">c</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span> <span class="nx">sortArray</span><span class="p">[</span><span class="nx">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttributes</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">customAttribute</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

					<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="nx">cal</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">index</span> <span class="o">=</span> <span class="nx">sortArray</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">index</span> <span class="p">];</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">index</span> <span class="o">=</span> <span class="nx">sortArray</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">];</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">index</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">index</span> <span class="o">=</span> <span class="nx">sortArray</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">];</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">index</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">index</span> <span class="o">=</span> <span class="nx">sortArray</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">];</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">index</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">index</span> <span class="o">=</span> <span class="nx">sortArray</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">];</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">index</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>      <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyVertices</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">vl</span><span class="p">;</span> <span class="nx">v</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">vertex</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">v</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

					<span class="nx">offset</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyColors</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">c</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span> <span class="nx">c</span> <span class="p">];</span>

					<span class="nx">offset</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
					<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
					<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttributes</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">customAttribute</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">&amp;&amp;</span>
					     <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
						   <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">cal</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

						<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span> <span class="p">)</span> <span class="p">{</span>

								<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

									<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

									<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

								<span class="p">}</span>

							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

								<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

									<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
									<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

									<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

								<span class="p">}</span>

							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>      <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyVertices</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sortParticles</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">vertexArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyColors</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sortParticles</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">colorArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">customAttribute</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sortParticles</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>


	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setLineBuffers</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">vertex</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span>

		<span class="nx">vertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">,</span>
		<span class="nx">colors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>
		<span class="nx">vl</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
		<span class="nx">cl</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>

		<span class="nx">vertexArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span><span class="p">,</span>
		<span class="nx">colorArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span><span class="p">,</span>

		<span class="nx">dirtyVertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span><span class="p">,</span>
		<span class="nx">dirtyColors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span><span class="p">,</span>

		<span class="nx">customAttributes</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">,</span>

		<span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span>
		<span class="nx">a</span><span class="p">,</span> <span class="nx">ca</span><span class="p">,</span> <span class="nx">cal</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span>
		<span class="nx">customAttribute</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyVertices</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">vl</span><span class="p">;</span> <span class="nx">v</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">vertex</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">v</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">vertexArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyColors</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">c</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span> <span class="nx">c</span> <span class="p">];</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">colorArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">customAttribute</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">&amp;&amp;</span>
					 <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
					   <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="nx">cal</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span> <span class="p">)</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

							<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

								<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	<span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
								<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

								<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

							<span class="p">}</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">&lt;</span> <span class="nx">cal</span><span class="p">;</span> <span class="nx">ca</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">ca</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	 <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setRibbonBuffers</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">vertex</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span>

		<span class="nx">vertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">,</span>
		<span class="nx">colors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>
		<span class="nx">vl</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
		<span class="nx">cl</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>

		<span class="nx">vertexArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__vertexArray</span><span class="p">,</span>
		<span class="nx">colorArray</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__colorArray</span><span class="p">,</span>

		<span class="nx">dirtyVertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span><span class="p">,</span>
		<span class="nx">dirtyColors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyVertices</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">vl</span><span class="p">;</span> <span class="nx">v</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">vertex</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">v</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertex</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">vertexArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyColors</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">c</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span> <span class="nx">c</span> <span class="p">];</span>

				<span class="nx">offset</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">colorArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setMeshBuffers</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">hint</span><span class="p">,</span> <span class="nx">dispose</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__inittedArrays</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>console.log( object );</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">normalType</span> <span class="o">=</span> <span class="nx">bufferGuessNormalType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">),</span>
		<span class="nx">vertexColorType</span> <span class="o">=</span> <span class="nx">bufferGuessVertexColorType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">),</span>
		<span class="nx">uvType</span> <span class="o">=</span> <span class="nx">bufferGuessUVType</span><span class="p">(</span> <span class="nx">material</span> <span class="p">),</span>

		<span class="nx">needsSmoothNormals</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">normalType</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SmoothShading</span> <span class="p">);</span>

		<span class="kd">var</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fl</span><span class="p">,</span> <span class="nx">fi</span><span class="p">,</span> <span class="nx">face</span><span class="p">,</span>
		<span class="nx">vertexNormals</span><span class="p">,</span> <span class="nx">faceNormal</span><span class="p">,</span> <span class="nx">normal</span><span class="p">,</span>
		<span class="nx">vertexColors</span><span class="p">,</span> <span class="nx">faceColor</span><span class="p">,</span>
		<span class="nx">vertexTangents</span><span class="p">,</span>
		<span class="nx">uv</span><span class="p">,</span> <span class="nx">uv2</span><span class="p">,</span> <span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">,</span> <span class="nx">v3</span><span class="p">,</span> <span class="nx">v4</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="nx">t4</span><span class="p">,</span>
		<span class="nx">c1</span><span class="p">,</span> <span class="nx">c2</span><span class="p">,</span> <span class="nx">c3</span><span class="p">,</span> <span class="nx">c4</span><span class="p">,</span>
		<span class="nx">sw1</span><span class="p">,</span> <span class="nx">sw2</span><span class="p">,</span> <span class="nx">sw3</span><span class="p">,</span> <span class="nx">sw4</span><span class="p">,</span>
		<span class="nx">si1</span><span class="p">,</span> <span class="nx">si2</span><span class="p">,</span> <span class="nx">si3</span><span class="p">,</span> <span class="nx">si4</span><span class="p">,</span>
		<span class="nx">sa1</span><span class="p">,</span> <span class="nx">sa2</span><span class="p">,</span> <span class="nx">sa3</span><span class="p">,</span> <span class="nx">sa4</span><span class="p">,</span>
		<span class="nx">sb1</span><span class="p">,</span> <span class="nx">sb2</span><span class="p">,</span> <span class="nx">sb3</span><span class="p">,</span> <span class="nx">sb4</span><span class="p">,</span>
		<span class="nx">m</span><span class="p">,</span> <span class="nx">ml</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span>
		<span class="nx">vn</span><span class="p">,</span> <span class="nx">uvi</span><span class="p">,</span> <span class="nx">uv2i</span><span class="p">,</span>
		<span class="nx">vk</span><span class="p">,</span> <span class="nx">vkl</span><span class="p">,</span> <span class="nx">vka</span><span class="p">,</span>
		<span class="nx">a</span><span class="p">,</span>

		<span class="nx">vertexIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_uv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_uv2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_face</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_normal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_tangent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_skin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_morphTarget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_custom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">offset_customSrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="nx">value</span><span class="p">,</span>

		<span class="nx">vertexArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__vertexArray</span><span class="p">,</span>
		<span class="nx">uvArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uvArray</span><span class="p">,</span>
		<span class="nx">uv2Array</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uv2Array</span><span class="p">,</span>
		<span class="nx">normalArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__normalArray</span><span class="p">,</span>
		<span class="nx">tangentArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__tangentArray</span><span class="p">,</span>
		<span class="nx">colorArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__colorArray</span><span class="p">,</span>

		<span class="nx">skinVertexAArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexAArray</span><span class="p">,</span>
		<span class="nx">skinVertexBArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexBArray</span><span class="p">,</span>
		<span class="nx">skinIndexArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinIndexArray</span><span class="p">,</span>
		<span class="nx">skinWeightArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinWeightArray</span><span class="p">,</span>

		<span class="nx">morphTargetsArrays</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__morphTargetsArrays</span><span class="p">,</span>

		<span class="nx">customAttributes</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">,</span>
		<span class="nx">customAttribute</span><span class="p">,</span>

		<span class="nx">faceArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__faceArray</span><span class="p">,</span>
		<span class="nx">lineArray</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__lineArray</span><span class="p">,</span>

		<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">,</span> <span class="c1">// this is shared for all chunks</span>

		<span class="nx">dirtyVertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span><span class="p">,</span>
		<span class="nx">dirtyElements</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyElements</span><span class="p">,</span>
		<span class="nx">dirtyUvs</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyUvs</span><span class="p">,</span>
		<span class="nx">dirtyNormals</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyNormals</span><span class="p">,</span>
		<span class="nx">dirtyTangents</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyTangents</span><span class="p">,</span>
		<span class="nx">dirtyColors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span><span class="p">,</span>
		<span class="nx">dirtyMorphTargets</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyMorphTargets</span><span class="p">,</span>

		<span class="nx">vertices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">,</span>
		<span class="nx">chunk_faces3</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">faces3</span><span class="p">,</span>
		<span class="nx">chunk_faces4</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">faces4</span><span class="p">,</span>
		<span class="nx">obj_faces</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faces</span><span class="p">,</span>

		<span class="nx">obj_uvs</span>  <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceVertexUvs</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span>
		<span class="nx">obj_uvs2</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faceVertexUvs</span><span class="p">[</span> <span class="mi">1</span> <span class="p">],</span>

		<span class="nx">obj_colors</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>

		<span class="nx">obj_skinVerticesA</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">skinVerticesA</span><span class="p">,</span>
		<span class="nx">obj_skinVerticesB</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">skinVerticesB</span><span class="p">,</span>
		<span class="nx">obj_skinIndices</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">skinIndices</span><span class="p">,</span>
		<span class="nx">obj_skinWeights</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">skinWeights</span><span class="p">,</span>

		<span class="nx">morphTargets</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">morphTargets</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyVertices</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">v1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
				<span class="nx">v2</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
				<span class="nx">v3</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">v1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
				<span class="nx">v2</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
				<span class="nx">v3</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
				<span class="nx">v4</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">vertexArray</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">offset</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">vertexArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyMorphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">vk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">vkl</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">vk</span> <span class="o">&lt;</span> <span class="nx">vkl</span><span class="p">;</span> <span class="nx">vk</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">offset_morphTarget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

					<span class="nx">v1</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
					<span class="nx">v2</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
					<span class="nx">v3</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

					<span class="nx">vka</span> <span class="o">=</span> <span class="nx">morphTargetsArrays</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">];</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="p">]</span> 	  <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">offset_morphTarget</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

					<span class="nx">v1</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
					<span class="nx">v2</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
					<span class="nx">v3</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>
					<span class="nx">v4</span> <span class="o">=</span> <span class="nx">morphTargets</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">].</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">].</span><span class="nx">position</span><span class="p">;</span>

					<span class="nx">vka</span> <span class="o">=</span> <span class="nx">morphTargetsArrays</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">];</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="p">]</span> 	  <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">vka</span><span class="p">[</span> <span class="nx">offset_morphTarget</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

					<span class="nx">offset_morphTarget</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">]</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">morphTargetsArrays</span><span class="p">[</span> <span class="nx">vk</span> <span class="p">],</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">obj_skinWeights</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>weights</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sw1</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sw2</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sw3</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>indices</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">si1</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">si2</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">si3</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>vertices A</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sa1</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sa2</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sa3</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// pad for faster vertex shader</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>vertices B</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sb1</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sb2</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sb3</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// pad for faster vertex shader</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">offset_skin</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>weights</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sw1</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sw2</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sw3</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
				<span class="nx">sw4</span> <span class="o">=</span> <span class="nx">obj_skinWeights</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinWeightArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sw4</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>indices</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">si1</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">si2</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">si3</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
				<span class="nx">si4</span> <span class="o">=</span> <span class="nx">obj_skinIndices</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinIndexArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">si4</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>vertices A</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sa1</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sa2</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sa3</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
				<span class="nx">sa4</span> <span class="o">=</span> <span class="nx">obj_skinVerticesA</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// pad for faster vertex shader</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sa4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexAArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>vertices B</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sb1</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
				<span class="nx">sb2</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
				<span class="nx">sb3</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
				<span class="nx">sb4</span> <span class="o">=</span> <span class="nx">obj_skinVerticesB</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// pad for faster vertex shader</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sb4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">skinVertexBArray</span><span class="p">[</span> <span class="nx">offset_skin</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">offset_skin</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">offset_skin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexABuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">skinVertexAArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexBBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">skinVertexBArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinIndicesBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">skinIndexArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinWeightsBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">skinWeightArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyColors</span> <span class="o">&amp;&amp;</span> <span class="nx">vertexColorType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

				<span class="nx">vertexColors</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexColors</span><span class="p">;</span>
				<span class="nx">faceColor</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">vertexColors</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">vertexColorType</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">VertexColors</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">c1</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
					<span class="nx">c2</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
					<span class="nx">c3</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">2</span> <span class="p">];</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">c1</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>
					<span class="nx">c2</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>
					<span class="nx">c3</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">offset_color</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">vertexColors</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexColors</span><span class="p">;</span>
				<span class="nx">faceColor</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">vertexColors</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">vertexColorType</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">VertexColors</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">c1</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
					<span class="nx">c2</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
					<span class="nx">c3</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">2</span> <span class="p">];</span>
					<span class="nx">c4</span> <span class="o">=</span> <span class="nx">vertexColors</span><span class="p">[</span> <span class="mi">3</span> <span class="p">];</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">c1</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>
					<span class="nx">c2</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>
					<span class="nx">c3</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>
					<span class="nx">c4</span> <span class="o">=</span> <span class="nx">faceColor</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c3</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">c4</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c4</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
				<span class="nx">colorArray</span><span class="p">[</span> <span class="nx">offset_color</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">c4</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="nx">offset_color</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">offset_color</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">colorArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyTangents</span> <span class="o">&amp;&amp;</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">hasTangents</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

				<span class="nx">vertexTangents</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexTangents</span><span class="p">;</span>

				<span class="nx">t1</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
				<span class="nx">t2</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
				<span class="nx">t3</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">2</span> <span class="p">];</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">offset_tangent</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">vertexTangents</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexTangents</span><span class="p">;</span>

				<span class="nx">t1</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
				<span class="nx">t2</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
				<span class="nx">t3</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">2</span> <span class="p">];</span>
				<span class="nx">t4</span> <span class="o">=</span> <span class="nx">vertexTangents</span><span class="p">[</span> <span class="mi">3</span> <span class="p">];</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">]</span>  <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
				<span class="nx">tangentArray</span><span class="p">[</span> <span class="nx">offset_tangent</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">t4</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

				<span class="nx">offset_tangent</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglTangentBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">tangentArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyNormals</span> <span class="o">&amp;&amp;</span> <span class="nx">normalType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

				<span class="nx">vertexNormals</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexNormals</span><span class="p">;</span>
				<span class="nx">faceNormal</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">normal</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">vertexNormals</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">needsSmoothNormals</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">vn</span> <span class="o">=</span> <span class="nx">vertexNormals</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

						<span class="nx">offset_normal</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

						<span class="nx">offset_normal</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">vertexNormals</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">vertexNormals</span><span class="p">;</span>
				<span class="nx">faceNormal</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">normal</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">vertexNormals</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">needsSmoothNormals</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">vn</span> <span class="o">=</span> <span class="nx">vertexNormals</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

						<span class="nx">offset_normal</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
						<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">offset_normal</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">faceNormal</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

						<span class="nx">offset_normal</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">normalArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyUvs</span> <span class="o">&amp;&amp;</span> <span class="nx">obj_uvs</span> <span class="o">&amp;&amp;</span> <span class="nx">uvType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">fi</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">];</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>
				<span class="nx">uv</span> <span class="o">=</span> <span class="nx">obj_uvs</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">uv</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uvi</span> <span class="o">=</span> <span class="nx">uv</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="nx">uvArray</span><span class="p">[</span> <span class="nx">offset_uv</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">uvi</span><span class="p">.</span><span class="nx">u</span><span class="p">;</span>
					<span class="nx">uvArray</span><span class="p">[</span> <span class="nx">offset_uv</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">uvi</span><span class="p">.</span><span class="nx">v</span><span class="p">;</span>

					<span class="nx">offset_uv</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">fi</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">];</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>
				<span class="nx">uv</span> <span class="o">=</span> <span class="nx">obj_uvs</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">uv</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uvi</span> <span class="o">=</span> <span class="nx">uv</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="nx">uvArray</span><span class="p">[</span> <span class="nx">offset_uv</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">uvi</span><span class="p">.</span><span class="nx">u</span><span class="p">;</span>
					<span class="nx">uvArray</span><span class="p">[</span> <span class="nx">offset_uv</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">uvi</span><span class="p">.</span><span class="nx">v</span><span class="p">;</span>

					<span class="nx">offset_uv</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">offset_uv</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUVBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">uvArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyUvs</span> <span class="o">&amp;&amp;</span> <span class="nx">obj_uvs2</span> <span class="o">&amp;&amp;</span> <span class="nx">uvType</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">fi</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">];</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>
				<span class="nx">uv2</span> <span class="o">=</span> <span class="nx">obj_uvs2</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">uv2</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uv2i</span> <span class="o">=</span> <span class="nx">uv2</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="nx">uv2Array</span><span class="p">[</span> <span class="nx">offset_uv2</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">uv2i</span><span class="p">.</span><span class="nx">u</span><span class="p">;</span>
					<span class="nx">uv2Array</span><span class="p">[</span> <span class="nx">offset_uv2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">uv2i</span><span class="p">.</span><span class="nx">v</span><span class="p">;</span>

					<span class="nx">offset_uv2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">fi</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">];</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>
				<span class="nx">uv2</span> <span class="o">=</span> <span class="nx">obj_uvs2</span><span class="p">[</span> <span class="nx">fi</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">uv2</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uv2i</span> <span class="o">=</span> <span class="nx">uv2</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="nx">uv2Array</span><span class="p">[</span> <span class="nx">offset_uv2</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">uv2i</span><span class="p">.</span><span class="nx">u</span><span class="p">;</span>
					<span class="nx">uv2Array</span><span class="p">[</span> <span class="nx">offset_uv2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">uv2i</span><span class="p">.</span><span class="nx">v</span><span class="p">;</span>

					<span class="nx">offset_uv2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">offset_uv2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUV2Buffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">uv2Array</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dirtyElements</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="p">]</span> 	 <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

				<span class="nx">offset_face</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

				<span class="nx">offset_line</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

				<span class="nx">vertexIndex</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="nx">faceArray</span><span class="p">[</span> <span class="nx">offset_face</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">offset_face</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="nx">lineArray</span><span class="p">[</span> <span class="nx">offset_line</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">vertexIndex</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

				<span class="nx">offset_line</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

				<span class="nx">vertexIndex</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">faceArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">lineArray</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">customAttribute</span> <span class="o">=</span> <span class="nx">customAttributes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">__original</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="nx">offset_custom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="nx">offset_customSrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;faces&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;faces&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>

					<span class="kd">var</span> <span class="nx">pp</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">pp</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="p">];</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

						<span class="nx">pp</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span> <span class="p">];</span>

					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;faces&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="p">]</span> 	   <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">[</span> <span class="nx">pp</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;vertices&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span>	<span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">face</span> <span class="o">=</span> <span class="nx">obj_faces</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">a</span> <span class="p">];</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">b</span> <span class="p">];</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">c</span> <span class="p">];</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">face</span><span class="p">.</span><span class="nx">d</span> <span class="p">];</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">boundTo</span> <span class="o">===</span> <span class="s2">&quot;faces&quot;</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces3</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">chunk_faces4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">value</span> <span class="o">=</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">chunk_faces4</span><span class="p">[</span> <span class="nx">f</span> <span class="p">]</span> <span class="p">];</span>

							<span class="nx">v1</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v2</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v3</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
							<span class="nx">v4</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span>  <span class="p">]</span> 	<span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">2</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">3</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">4</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">5</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">6</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">7</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">9</span>  <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">11</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">12</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">13</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">14</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
							<span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span> <span class="nx">offset_custom</span> <span class="o">+</span> <span class="mi">15</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

							<span class="nx">offset_custom</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">customAttribute</span><span class="p">.</span><span class="nx">array</span><span class="p">,</span> <span class="nx">hint</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">dispose</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__inittedArrays</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__colorArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__normalArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__tangentArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uvArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__uv2Array</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__faceArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__vertexArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__lineArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexAArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinVertexBArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinIndexArray</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__skinWeightArray</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Buffer rendering</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">renderBufferImmediate</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">shading</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">)</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="p">)</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">hasPos</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">positionArray</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">hasNormal</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">shading</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FlatShading</span> <span class="p">)</span> <span class="p">{</span>

				<span class="kd">var</span> <span class="nx">nx</span><span class="p">,</span> <span class="nx">ny</span><span class="p">,</span> <span class="nx">nz</span><span class="p">,</span>
					<span class="nx">nax</span><span class="p">,</span> <span class="nx">nbx</span><span class="p">,</span> <span class="nx">ncx</span><span class="p">,</span> <span class="nx">nay</span><span class="p">,</span> <span class="nx">nby</span><span class="p">,</span> <span class="nx">ncy</span><span class="p">,</span> <span class="nx">naz</span><span class="p">,</span> <span class="nx">nbz</span><span class="p">,</span> <span class="nx">ncz</span><span class="p">,</span>
					<span class="nx">normalArray</span><span class="p">,</span>
					<span class="nx">i</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">count</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">normalArray</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">normalArray</span><span class="p">;</span>

					<span class="nx">nax</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
					<span class="nx">nay</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">];</span>
					<span class="nx">naz</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">];</span>

					<span class="nx">nbx</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">];</span>
					<span class="nx">nby</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">];</span>
					<span class="nx">nbz</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">];</span>

					<span class="nx">ncx</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">];</span>
					<span class="nx">ncy</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">];</span>
					<span class="nx">ncz</span>  <span class="o">=</span> <span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">];</span>

					<span class="nx">nx</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">nax</span> <span class="o">+</span> <span class="nx">nbx</span> <span class="o">+</span> <span class="nx">ncx</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
					<span class="nx">ny</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">nay</span> <span class="o">+</span> <span class="nx">nby</span> <span class="o">+</span> <span class="nx">ncy</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
					<span class="nx">nz</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">naz</span> <span class="o">+</span> <span class="nx">nbz</span> <span class="o">+</span> <span class="nx">ncz</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> 	 <span class="o">=</span> <span class="nx">nx</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">ny</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">nz</span><span class="p">;</span>

					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">nx</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">ny</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">nz</span><span class="p">;</span>

					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">nx</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">ny</span><span class="p">;</span>
					<span class="nx">normalArray</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">nz</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">normalArray</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">count</span> <span class="p">);</span>

		<span class="nx">object</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">renderBuffer</span> <span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

		<span class="kd">var</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">linewidth</span><span class="p">,</span> <span class="nx">primitives</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">;</span>

		<span class="nx">program</span> <span class="o">=</span> <span class="nx">setProgram</span><span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="nx">attributes</span> <span class="o">=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>

		<span class="kd">var</span> <span class="nx">updateBuffers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">wireframeBit</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">wireframe</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">geometryGroupHash</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">id</span> <span class="o">*</span> <span class="mh">0xffffff</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">program</span><span class="p">.</span><span class="nx">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="nx">wireframeBit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroupHash</span> <span class="o">!==</span> <span class="nx">_currentGeometryGroupHash</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_currentGeometryGroupHash</span> <span class="o">=</span> <span class="nx">geometryGroupHash</span><span class="p">;</span>
			<span class="nx">updateBuffers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>vertices</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">material</span><span class="p">.</span><span class="nx">morphTargets</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">updateBuffers</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetBase</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setupMorphTargets</span><span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span> <span class="nx">updateBuffers</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>custom attributes</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Use the per-geometryGroup custom attribute arrays which are setup in initMeshBuffers</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">attribute</span> <span class="o">=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglCustomAttributesList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="k">if</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">belongsToAttribute</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span> <span class="p">);</span>
						<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">belongsToAttribute</span> <span class="p">],</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>colors</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">color</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglColorBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>normals</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglNormalBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>tangents</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">tangent</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglTangentBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">tangent</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>uvs</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUVBuffer</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUVBuffer</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span> <span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">disableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv2</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUV2Buffer</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglUV2Buffer</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv2</span> <span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">disableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv2</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span> <span class="o">&amp;&amp;</span>
				 <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexA</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexB</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				 <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinWeight</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexABuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexA</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinVertexBBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinIndicesBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinIndex</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglSkinWeightsBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinWeight</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>render mesh</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>wireframe</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">wireframe</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setLineWidth</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">wireframeLinewidth</span> <span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">updateBuffers</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawElements</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINES</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineCount</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>triangles</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">updateBuffers</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceBuffer</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawElements</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceCount</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">calls</span> <span class="o">++</span><span class="p">;</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">vertices</span> <span class="o">+=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceCount</span><span class="p">;</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">faces</span> <span class="o">+=</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglFaceCount</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>render lines</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">primitives</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LineStrip</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINE_STRIP</span> <span class="o">:</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINES</span><span class="p">;</span>

			<span class="nx">setLineWidth</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">linewidth</span> <span class="p">);</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span> <span class="nx">primitives</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglLineCount</span> <span class="p">);</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">calls</span> <span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>render particles</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">POINTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglParticleCount</span> <span class="p">);</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">calls</span> <span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>render ribbon</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TRIANGLE_STRIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexCount</span> <span class="p">);</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">calls</span> <span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setupMorphTargets</span> <span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>set base</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetBase</span> <span class="o">!==</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">[</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetBase</span> <span class="p">]</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetForcedOrder</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>set forced order</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetForcedOrder</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">influences</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetInfluences</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">numSupportedMorphTargets</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">[</span> <span class="nx">order</span><span class="p">[</span> <span class="nx">m</span> <span class="p">]</span> <span class="p">]</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="s2">&quot;morphTarget&quot;</span> <span class="o">+</span> <span class="nx">m</span> <span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span><span class="p">[</span> <span class="nx">m</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">influences</span><span class="p">[</span> <span class="nx">order</span><span class="p">[</span> <span class="nx">m</span> <span class="p">]</span> <span class="p">];</span>

				<span class="nx">m</span> <span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>find most influencing</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">used</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="kd">var</span> <span class="nx">candidateInfluence</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">candidate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">influences</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetInfluences</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">influences</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetBase</span> <span class="o">!==</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">used</span><span class="p">[</span> <span class="nx">object</span><span class="p">.</span><span class="nx">morphTargetBase</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">while</span> <span class="p">(</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">numSupportedMorphTargets</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">used</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">influences</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="nx">candidateInfluence</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">candidate</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
						<span class="nx">candidateInfluence</span> <span class="o">=</span> <span class="nx">influences</span><span class="p">[</span> <span class="nx">candidate</span> <span class="p">];</span>

					<span class="p">}</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglMorphTargetsBuffers</span><span class="p">[</span> <span class="nx">candidate</span> <span class="p">]</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="s2">&quot;morphTarget&quot;</span> <span class="o">+</span> <span class="nx">m</span> <span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span><span class="p">[</span> <span class="nx">m</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">candidateInfluence</span><span class="p">;</span>

				<span class="nx">used</span><span class="p">[</span> <span class="nx">candidate</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">candidateInfluence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="nx">m</span> <span class="o">++</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>load updated influences uniform</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">morphTargetInfluences</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1fv</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">morphTargetInfluences</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Frustum</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">computeFrustum</span> <span class="p">(</span> <span class="nx">m</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n11</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n12</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n13</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n14</span> <span class="p">);</span>
		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n11</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n12</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n13</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n14</span> <span class="p">);</span>
		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">2</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n21</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n22</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n23</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n24</span> <span class="p">);</span>
		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">3</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n21</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n22</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n23</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n24</span> <span class="p">);</span>
		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">4</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n31</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n32</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n33</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n34</span> <span class="p">);</span>
		<span class="nx">_frustum</span><span class="p">[</span> <span class="mi">5</span> <span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n41</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n31</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n42</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n32</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n43</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n33</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n44</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">n34</span> <span class="p">);</span>

		<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">plane</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">plane</span> <span class="o">=</span> <span class="nx">_frustum</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">plane</span><span class="p">.</span><span class="nx">divideScalar</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">plane</span><span class="p">.</span><span class="nx">z</span> <span class="p">)</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">isInFrustum</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">distance</span><span class="p">,</span> <span class="nx">matrix</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">,</span>
		<span class="nx">radius</span> <span class="o">=</span> <span class="o">-</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">boundingSphere</span><span class="p">.</span><span class="nx">radius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">z</span> <span class="p">)</span> <span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">distance</span> <span class="o">=</span> <span class="nx">_frustum</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">matrix</span><span class="p">.</span><span class="nx">n14</span> <span class="o">+</span> <span class="nx">_frustum</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">matrix</span><span class="p">.</span><span class="nx">n24</span> <span class="o">+</span> <span class="nx">_frustum</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">matrix</span><span class="p">.</span><span class="nx">n34</span> <span class="o">+</span> <span class="nx">_frustum</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">w</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">distance</span> <span class="o">&lt;=</span> <span class="nx">radius</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

	<span class="p">};</span>


	<span class="kd">function</span> <span class="nx">painterSort</span> <span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Rendering</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">forceClear</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span>

		<span class="nx">program</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span>
		<span class="nx">webglObject</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span>
		<span class="nx">renderList</span><span class="p">,</span>

		<span class="nx">lights</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">lights</span><span class="p">,</span>
		<span class="nx">fog</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">fog</span><span class="p">;</span>

		<span class="nx">_currentMaterialId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoUpdateObjects</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">initWebGLObjects</span><span class="p">(</span> <span class="nx">scene</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">parent</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;DEPRECATED: Camera hasn\&#39;t been added to a Scene. Adding it...&#39;</span> <span class="p">);</span>
			<span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">camera</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoUpdateScene</span> <span class="p">)</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">updateMatrixWorld</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapEnabled</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapAutoUpdate</span> <span class="p">)</span> <span class="nx">renderShadowMap</span><span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">vertices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">faces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>
		<span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">_viewMatrixArray</span> <span class="p">);</span>
		<span class="nx">camera</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">_projectionMatrixArray</span> <span class="p">);</span>

		<span class="nx">_projScreenMatrix</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorldInverse</span> <span class="p">);</span>
		<span class="nx">computeFrustum</span><span class="p">(</span> <span class="nx">_projScreenMatrix</span> <span class="p">);</span>

		<span class="nx">setRenderTarget</span><span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoClear</span> <span class="o">||</span> <span class="nx">forceClear</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoClearColor</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoClearDepth</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoClearStencil</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>set matrices for regular objects (frustum culled)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">renderList</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

			<span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">frustumCulled</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">isInFrustum</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

					<span class="nx">setupMatrices</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>

					<span class="nx">unrollBufferMaterial</span><span class="p">(</span> <span class="nx">webglObject</span> <span class="p">);</span>

					<span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">sortObjects</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">renderDepth</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">webglObject</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">renderDepth</span><span class="p">;</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

							<span class="nx">_vector3</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
							<span class="nx">_projScreenMatrix</span><span class="p">.</span><span class="nx">multiplyVector3</span><span class="p">(</span> <span class="nx">_vector3</span> <span class="p">);</span>

							<span class="nx">webglObject</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">_vector3</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">sortObjects</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">renderList</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="nx">painterSort</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>set matrices for immediate objects</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">renderList</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixAutoUpdate</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">setupMatrices</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>

				<span class="nx">unrollImmediateBufferMaterial</span><span class="p">(</span> <span class="nx">webglObject</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">setBlending</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">blending</span> <span class="p">);</span>
			<span class="nx">setDepthTest</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">depthTest</span> <span class="p">);</span>
			<span class="nx">setDepthWrite</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">depthWrite</span> <span class="p">);</span>
			<span class="nx">setPolygonOffset</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">polygonOffset</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">polygonOffsetFactor</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span><span class="p">.</span><span class="nx">polygonOffsetUnits</span> <span class="p">);</span>

			<span class="nx">renderObjects</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span> <span class="p">);</span>
			<span class="nx">renderObjectsImmediate</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">overrideMaterial</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>opaque pass (front-to-back order)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setBlending</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NormalBlending</span> <span class="p">);</span>

			<span class="nx">renderObjects</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
			<span class="nx">renderObjectsImmediate</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>transparent pass (back-to-front order)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">renderObjects</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;transparent&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
			<span class="nx">renderObjectsImmediate</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">,</span> <span class="s2">&quot;transparent&quot;</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>render 2d</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">renderSprites</span><span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Generate mipmap if we're using any kind of mipmap filtering</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="o">&amp;&amp;</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">minFilter</span> <span class="o">!==</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestFilter</span> <span class="o">&amp;&amp;</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">minFilter</span> <span class="o">!==</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearFilter</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">updateRenderTargetMipmap</span><span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>_gl.finish();</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">renderShadowMap</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">jl</span><span class="p">,</span>

		<span class="nx">shadowMap</span><span class="p">,</span> <span class="nx">shadowMatrix</span><span class="p">,</span>
		<span class="nx">program</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span>
		<span class="nx">webglObject</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">light</span><span class="p">,</span>

		<span class="nx">shadowIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="nx">lights</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">lights</span><span class="p">,</span>
		<span class="nx">fog</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">_cameraLight</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_cameraLight</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PerspectiveCamera</span><span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowCameraFov</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapWidth</span> <span class="o">/</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapHeight</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowCameraNear</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowCameraFar</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">light</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span><span class="p">.</span><span class="nx">castShadow</span> <span class="o">&amp;&amp;</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SpotLight</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_currentMaterialId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMap</span><span class="p">[</span> <span class="nx">shadowIndex</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>

					<span class="kd">var</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">minFilter</span><span class="o">:</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearFilter</span><span class="p">,</span> <span class="nx">magFilter</span><span class="o">:</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearFilter</span><span class="p">,</span> <span class="nx">format</span><span class="o">:</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">RGBAFormat</span> <span class="p">};</span>

					<span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMap</span><span class="p">[</span> <span class="nx">shadowIndex</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderTarget</span><span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapWidth</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapHeight</span><span class="p">,</span> <span class="nx">pars</span> <span class="p">);</span>
					<span class="nx">_shadowMatrix</span><span class="p">[</span> <span class="nx">shadowIndex</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>

				<span class="p">}</span>

				<span class="nx">shadowMap</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMap</span><span class="p">[</span> <span class="nx">shadowIndex</span> <span class="p">];</span>
				<span class="nx">shadowMatrix</span> <span class="o">=</span> <span class="nx">_shadowMatrix</span><span class="p">[</span> <span class="nx">shadowIndex</span> <span class="p">];</span>

				<span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">light</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
				<span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span> <span class="nx">light</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s2">&quot;Camera is not on the Scene. Adding it...&quot;</span> <span class="p">);</span>
					<span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">_cameraLight</span> <span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoUpdateScene</span> <span class="p">)</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">updateMatrixWorld</span><span class="p">();</span>

				<span class="p">}</span>

				<span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>compute shadow matrix</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">shadowMatrix</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
								  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
								  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
								  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="p">);</span>

				<span class="nx">shadowMatrix</span><span class="p">.</span><span class="nx">multiplySelf</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">projectionMatrix</span> <span class="p">);</span>
				<span class="nx">shadowMatrix</span><span class="p">.</span><span class="nx">multiplySelf</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">matrixWorldInverse</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>render shadow map</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">_viewMatrixArray</span> <span class="p">);</span>
				<span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">_projectionMatrixArray</span> <span class="p">);</span>

				<span class="nx">_projScreenMatrix</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">,</span> <span class="nx">_cameraLight</span><span class="p">.</span><span class="nx">matrixWorldInverse</span> <span class="p">);</span>
				<span class="nx">computeFrustum</span><span class="p">(</span> <span class="nx">_projScreenMatrix</span> <span class="p">);</span>

				<span class="nx">setRenderTarget</span><span class="p">(</span> <span class="nx">shadowMap</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>using arbitrary clear color in depth pass
creates variance in shadows</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>_gl.clearColor( 0, 0, 0, 1 );</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">_this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">_clearAlpha</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>set matrices &amp; frustum culling</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">jl</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">jl</span><span class="p">;</span> <span class="nx">j</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">[</span> <span class="nx">j</span> <span class="p">];</span>
					<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

					<span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">castShadow</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">frustumCulled</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">isInFrustum</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

							<span class="nx">setupMatrices</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">_cameraLight</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

							<span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>render regular objects</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">setDepthTest</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
				<span class="nx">setBlending</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NormalBlending</span> <span class="p">);</span> <span class="c1">// maybe blending should be just disabled?</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>_gl.cullFace( _gl.FRONT );</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">jl</span><span class="p">;</span> <span class="nx">j</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">[</span> <span class="nx">j</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>
						<span class="nx">buffer</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>

						<span class="nx">setObjectFaces</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">customDepthMaterial</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">material</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">customDepthMaterial</span><span class="p">;</span>

						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">morphTargets</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">material</span> <span class="o">=</span> <span class="nx">_depthMaterialMorph</span><span class="p">;</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

							<span class="nx">material</span> <span class="o">=</span> <span class="nx">_depthMaterial</span><span class="p">;</span>

						<span class="p">}</span>

						<span class="nx">renderBuffer</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

					<span class="p">}</span>

				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>set matrices and render immediate objects</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">jl</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">jl</span><span class="p">;</span> <span class="nx">j</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">[</span> <span class="nx">j</span> <span class="p">];</span>
					<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">castShadow</span> <span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixAutoUpdate</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

						<span class="p">}</span>

						<span class="nx">_currentGeometryGroupHash</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

						<span class="nx">setupMatrices</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">_cameraLight</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

						<span class="nx">setObjectFaces</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

						<span class="nx">program</span> <span class="o">=</span> <span class="nx">setProgram</span><span class="p">(</span> <span class="nx">_cameraLight</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">_depthMaterial</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span> <span class="p">)</span> <span class="p">{</span>

							<span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">,</span> <span class="nx">_frustum</span> <span class="p">);</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

							<span class="nx">object</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">renderBufferImmediate</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">_depthMaterial</span><span class="p">.</span><span class="nx">shading</span> <span class="p">);</span> <span class="p">}</span> <span class="p">);</span>

						<span class="p">}</span>

					<span class="p">}</span>

				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>_gl.cullFace( _gl.BACK );</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">shadowIndex</span> <span class="o">++</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">renderObjects</span> <span class="p">(</span> <span class="nx">renderList</span><span class="p">,</span> <span class="nx">reverse</span><span class="p">,</span> <span class="nx">materialType</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">useBlending</span><span class="p">,</span> <span class="nx">overrideMaterial</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">webglObject</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">delta</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">reverse</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">start</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nx">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="nx">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nx">end</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			<span class="nx">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">end</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">render</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>
				<span class="nx">buffer</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">overrideMaterial</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">material</span> <span class="o">=</span> <span class="nx">overrideMaterial</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">material</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">[</span> <span class="nx">materialType</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">material</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">useBlending</span> <span class="p">)</span> <span class="nx">setBlending</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">blending</span> <span class="p">);</span>

					<span class="nx">setDepthTest</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">depthTest</span> <span class="p">);</span>
					<span class="nx">setDepthWrite</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">depthWrite</span> <span class="p">);</span>
					<span class="nx">setPolygonOffset</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffset</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffsetFactor</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffsetUnits</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">setObjectFaces</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

				<span class="nx">renderBuffer</span><span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">renderObjectsImmediate</span> <span class="p">(</span> <span class="nx">renderList</span><span class="p">,</span> <span class="nx">materialType</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">useBlending</span><span class="p">,</span> <span class="nx">overrideMaterial</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">webglObject</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">program</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">webglObject</span> <span class="o">=</span> <span class="nx">renderList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">object</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_currentGeometryGroupHash</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">overrideMaterial</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">material</span> <span class="o">=</span> <span class="nx">overrideMaterial</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">material</span> <span class="o">=</span> <span class="nx">webglObject</span><span class="p">[</span> <span class="nx">materialType</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">material</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span> <span class="nx">useBlending</span> <span class="p">)</span> <span class="nx">setBlending</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">blending</span> <span class="p">);</span>

					<span class="nx">setDepthTest</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">depthTest</span> <span class="p">);</span>
					<span class="nx">setDepthWrite</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">depthWrite</span> <span class="p">);</span>
					<span class="nx">setPolygonOffset</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffset</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffsetFactor</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">polygonOffsetUnits</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">setObjectFaces</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

				<span class="nx">program</span> <span class="o">=</span> <span class="nx">setProgram</span><span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">,</span> <span class="nx">_frustum</span> <span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">object</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">renderBufferImmediate</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">shading</span> <span class="p">);</span> <span class="p">}</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">unrollImmediateBufferMaterial</span> <span class="p">(</span> <span class="nx">globject</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">globject</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span>
			<span class="nx">material</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">transparent</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
			<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
			<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">unrollBufferMaterial</span> <span class="p">(</span> <span class="nx">globject</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">globject</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span>
			<span class="nx">buffer</span> <span class="o">=</span> <span class="nx">globject</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span>
			<span class="nx">material</span><span class="p">,</span> <span class="nx">materialIndex</span><span class="p">,</span> <span class="nx">meshMaterial</span><span class="p">;</span>

		<span class="nx">meshMaterial</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">material</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">meshMaterial</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshFaceMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">materialIndex</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">materialIndex</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">materialIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">material</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">materials</span><span class="p">[</span> <span class="nx">materialIndex</span> <span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">transparent</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
					<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
					<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">material</span> <span class="o">=</span> <span class="nx">meshMaterial</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">transparent</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
					<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">globject</span><span class="p">.</span><span class="nx">opaque</span> <span class="o">=</span> <span class="nx">material</span><span class="p">;</span>
					<span class="nx">globject</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">renderSprites</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">ol</span><span class="p">,</span> <span class="nx">object</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">uniforms</span> <span class="o">=</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">invAspect</span> <span class="o">=</span> <span class="nx">_viewportHeight</span> <span class="o">/</span> <span class="nx">_viewportWidth</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">scale</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="kd">var</span> <span class="nx">screenPosition</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">halfViewportWidth</span> <span class="o">=</span> <span class="nx">_viewportWidth</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">halfViewportHeight</span> <span class="o">=</span> <span class="nx">_viewportHeight</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">mergeWith3D</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>setup gl</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">_gl</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span> <span class="p">);</span>
		<span class="nx">_currentProgram</span> <span class="o">=</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">;</span>
		<span class="nx">_oldBlending</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="nx">_oldDepthTest</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="nx">_currentGeometryGroupHash</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_spriteAttributesEnabled</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span> <span class="p">);</span>

			<span class="nx">_spriteAttributesEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">BLEND</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">depthMask</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">elementBuffer</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">_projectionMatrixArray</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>update positions and sort</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span><span class="p">(</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ol</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="nx">ol</span><span class="p">;</span> <span class="nx">o</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">object</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">[</span> <span class="nx">o</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">useScreenCoordinates</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span><span class="p">.</span><span class="nx">multiplyToArray</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span> <span class="p">);</span>
				<span class="nx">object</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="o">-</span><span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span><span class="p">.</span><span class="nx">n34</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">object</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="o">-</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="nx">painterSort</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>render all sprites</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ol</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="nx">ol</span><span class="p">;</span> <span class="nx">o</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">object</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">[</span> <span class="nx">o</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">visible</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">image</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">useScreenCoordinates</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">useScreenCoordinates</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">screenPosition</span><span class="p">,</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">halfViewportWidth</span>  <span class="p">)</span> <span class="o">/</span> <span class="nx">halfViewportWidth</span><span class="p">,</span>
															<span class="p">(</span> <span class="nx">halfViewportHeight</span> <span class="o">-</span> <span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="p">)</span> <span class="o">/</span> <span class="nx">halfViewportHeight</span><span class="p">,</span>
															  <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="p">)));</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">useScreenCoordinates</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">affectedByDistance</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">affectedByDistance</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">modelViewMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">size</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scaleByViewport</span> <span class="o">?</span> <span class="nx">_viewportHeight</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">);</span>

				<span class="nx">scale</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">size</span> <span class="o">*</span> <span class="nx">invAspect</span> <span class="o">*</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">scale</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">size</span> <span class="o">*</span> <span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform2f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">uvScale</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">uvScale</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">uvScale</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform2f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">uvOffset</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">uvOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">uvOffset</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform2f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">alignment</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">alignment</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">alignment</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">opacity</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">rotation</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">rotation</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform2fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">scale</span> <span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">mergeWith3D</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mergeWith3D</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>
					<span class="nx">mergeWith3D</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">mergeWith3D</span> <span class="o">&amp;&amp;</span> <span class="nx">mergeWith3D</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>
					<span class="nx">mergeWith3D</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">setBlending</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">blending</span> <span class="p">);</span>
				<span class="nx">setTexture</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">drawElements</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>restore gl</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">depthMask</span><span class="p">(</span> <span class="nx">_oldDepthWrite</span> <span class="p">);</span>

	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Geometry splitting</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">sortFacesByMaterial</span> <span class="p">(</span> <span class="nx">geometry</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fl</span><span class="p">,</span> <span class="nx">face</span><span class="p">,</span> <span class="nx">materialIndex</span><span class="p">,</span> <span class="nx">vertices</span><span class="p">,</span>
			<span class="nx">materialHash</span><span class="p">,</span> <span class="nx">groupHash</span><span class="p">,</span>
			<span class="nx">hash_map</span> <span class="o">=</span> <span class="p">{};</span>

		<span class="kd">var</span> <span class="nx">numMorphTargets</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">morphTargets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="o">=</span> <span class="p">{};</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fl</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faces</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">f</span> <span class="o">&lt;</span> <span class="nx">fl</span><span class="p">;</span> <span class="nx">f</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">face</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">f</span> <span class="p">];</span>
			<span class="nx">materialIndex</span> <span class="o">=</span> <span class="nx">face</span><span class="p">.</span><span class="nx">materialIndex</span><span class="p">;</span>

			<span class="nx">materialHash</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">materialIndex</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">materialIndex</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;hash&#39;</span><span class="o">:</span> <span class="nx">materialHash</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

			<span class="p">}</span>

			<span class="nx">groupHash</span> <span class="o">=</span> <span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">].</span><span class="nx">hash</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">].</span><span class="nx">counter</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;faces3&#39;</span><span class="o">:</span> <span class="p">[],</span> <span class="s1">&#39;faces4&#39;</span><span class="o">:</span> <span class="p">[],</span> <span class="s1">&#39;materialIndex&#39;</span><span class="o">:</span> <span class="nx">materialIndex</span><span class="p">,</span> <span class="s1">&#39;vertices&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;numMorphTargets&#39;</span><span class="o">:</span> <span class="nx">numMorphTargets</span> <span class="p">};</span>

			<span class="p">}</span>

			<span class="nx">vertices</span> <span class="o">=</span> <span class="nx">face</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Face3</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">].</span><span class="nx">vertices</span> <span class="o">+</span> <span class="nx">vertices</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">].</span><span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">groupHash</span> <span class="o">=</span> <span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">].</span><span class="nx">hash</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nx">hash_map</span><span class="p">[</span> <span class="nx">materialHash</span> <span class="p">].</span><span class="nx">counter</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;faces3&#39;</span><span class="o">:</span> <span class="p">[],</span> <span class="s1">&#39;faces4&#39;</span><span class="o">:</span> <span class="p">[],</span> <span class="s1">&#39;materialIndex&#39;</span><span class="o">:</span> <span class="nx">materialIndex</span><span class="p">,</span> <span class="s1">&#39;vertices&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;numMorphTargets&#39;</span><span class="o">:</span> <span class="nx">numMorphTargets</span> <span class="p">};</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">face</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Face3</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">].</span><span class="nx">faces3</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">f</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">].</span><span class="nx">faces4</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">f</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">groupHash</span> <span class="p">].</span><span class="nx">vertices</span> <span class="o">+=</span> <span class="nx">vertices</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroupsList</span> <span class="o">=</span> <span class="p">[];</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">g</span> <span class="p">].</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">_geometryGroupCounter</span> <span class="o">++</span><span class="p">;</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroupsList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">g</span> <span class="p">]</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Objects refresh</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">initWebGLObjects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">scene</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span> <span class="o">=</span> <span class="p">[];</span>

		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsAdded</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">addObject</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsAdded</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="nx">scene</span> <span class="p">);</span>
			<span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsAdded</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsRemoved</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">removeObject</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsRemoved</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="nx">scene</span> <span class="p">);</span>
			<span class="nx">scene</span><span class="p">.</span><span class="nx">__objectsRemoved</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>update must be called after objects adding / removal</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ol</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&lt;</span> <span class="nx">ol</span><span class="p">;</span> <span class="nx">o</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">updateObject</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">[</span> <span class="nx">o</span> <span class="p">].</span><span class="nx">object</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Objects adding</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">addObject</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">scene</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">object</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

			<span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>

			<span class="nx">object</span><span class="p">.</span><span class="nx">_normalMatrixArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">9</span> <span class="p">);</span>
			<span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="p">);</span>
			<span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="p">);</span>

			<span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">sortFacesByMaterial</span><span class="p">(</span> <span class="nx">geometry</span> <span class="p">);</span>

				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>create separate VBOs per geometry chunk</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">for</span> <span class="p">(</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">geometryGroup</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">g</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>initialise VBO on the first access</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">geometryGroup</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">createMeshBuffers</span><span class="p">(</span> <span class="nx">geometryGroup</span> <span class="p">);</span>
						<span class="nx">initMeshBuffers</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyMorphTargets</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyElements</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyUvs</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyNormals</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyTangents</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
						<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">createRibbonBuffers</span><span class="p">(</span> <span class="nx">geometry</span> <span class="p">);</span>
					<span class="nx">initRibbonBuffers</span><span class="p">(</span> <span class="nx">geometry</span> <span class="p">);</span>

					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">createLineBuffers</span><span class="p">(</span> <span class="nx">geometry</span> <span class="p">);</span>
					<span class="nx">initLineBuffers</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__webglVertexBuffer</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">createParticleBuffers</span><span class="p">(</span> <span class="nx">geometry</span> <span class="p">);</span>
					<span class="nx">initParticleBuffers</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglActive</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">geometryGroup</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroups</span><span class="p">[</span> <span class="nx">g</span> <span class="p">];</span>

					<span class="nx">addBuffer</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="o">||</span>
						<span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="o">||</span>
						<span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">;</span>
				<span class="nx">addBuffer</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MarchingCubes</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MarchingCubes</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">addBufferImmediate</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Sprite</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">object</span><span class="p">.</span><span class="nx">__webglActive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">addBuffer</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">objlist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
			<span class="p">{</span>
				<span class="nx">buffer</span><span class="o">:</span> <span class="nx">buffer</span><span class="p">,</span>
				<span class="nx">object</span><span class="o">:</span> <span class="nx">object</span><span class="p">,</span>
				<span class="nx">opaque</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
				<span class="nx">transparent</span><span class="o">:</span> <span class="kc">null</span>
			<span class="p">}</span>
		<span class="p">);</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">addBufferImmediate</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">objlist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
			<span class="p">{</span>
				<span class="nx">object</span><span class="o">:</span> <span class="nx">object</span><span class="p">,</span>
				<span class="nx">opaque</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
				<span class="nx">transparent</span><span class="o">:</span> <span class="kc">null</span>
			<span class="p">}</span>
		<span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Objects updates</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">updateObject</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">geometry</span><span class="p">,</span>
			<span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">customAttributesDirty</span><span class="p">,</span> <span class="nx">material</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>check all geometry groups</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroupsList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">geometryGroup</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">geometryGroupsList</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

				<span class="nx">material</span> <span class="o">=</span> <span class="nx">getBufferMaterial</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">geometryGroup</span> <span class="p">);</span>

				<span class="nx">customAttributesDirty</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">areCustomAttributesDirty</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyMorphTargets</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyElements</span> <span class="o">||</span>
					 <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyUvs</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyNormals</span> <span class="o">||</span>
					 <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyTangents</span> <span class="o">||</span> <span class="nx">customAttributesDirty</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">setMeshBuffers</span><span class="p">(</span> <span class="nx">geometryGroup</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span><span class="p">,</span> <span class="o">!</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">dynamic</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyMorphTargets</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyElements</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyUvs</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyNormals</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyTangents</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">clearCustomAttributes</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setRibbonBuffers</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">material</span> <span class="o">=</span> <span class="nx">getBufferMaterial</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">geometryGroup</span> <span class="p">);</span>

			<span class="nx">customAttributesDirty</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">areCustomAttributesDirty</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">||</span>  <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">||</span> <span class="nx">customAttributesDirty</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setLineBuffers</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">clearCustomAttributes</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">material</span> <span class="o">=</span> <span class="nx">getBufferMaterial</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">geometryGroup</span> <span class="p">);</span>

			<span class="nx">customAttributesDirty</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">areCustomAttributesDirty</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">||</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sortParticles</span> <span class="o">||</span> <span class="nx">customAttributesDirty</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setParticleBuffers</span><span class="p">(</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DYNAMIC_DRAW</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">clearCustomAttributes</span><span class="p">(</span> <span class="nx">material</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Objects updates - custom attributes check</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">areCustomAttributesDirty</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">].</span><span class="nx">needsUpdate</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">clearCustomAttributes</span> <span class="p">(</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">].</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Objects removal</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">removeObject</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">scene</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span>  <span class="o">||</span>
			 <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span> <span class="o">||</span>
			 <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Ribbon</span> <span class="o">||</span>
			 <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">removeInstances</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjects</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Sprite</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">removeInstancesDirect</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglSprites</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MarchingCubes</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">immediateRenderCallback</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">removeInstances</span><span class="p">(</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">__webglObjectsImmediate</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">object</span><span class="p">.</span><span class="nx">__webglActive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">removeInstances</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">objlist</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">o</span> <span class="o">--</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">[</span> <span class="nx">o</span> <span class="p">].</span><span class="nx">object</span> <span class="o">===</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">objlist</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="nx">o</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">removeInstancesDirect</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">objlist</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">o</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">o</span> <span class="o">--</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">objlist</span><span class="p">[</span> <span class="nx">o</span> <span class="p">]</span> <span class="o">===</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">objlist</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="nx">o</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Materials</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">initMaterial</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">identifiers</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">,</span> <span class="nx">maxLightCount</span><span class="p">,</span> <span class="nx">maxBones</span><span class="p">,</span> <span class="nx">maxShadows</span><span class="p">,</span> <span class="nx">shaderID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshDepthMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshNormalMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;basic&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;lambert&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;phong&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LineBasicMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;basic&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleBasicMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shaderID</span> <span class="o">=</span> <span class="s1">&#39;particle_basic&#39;</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">shaderID</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">setMaterialShaders</span><span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderLib</span><span class="p">[</span> <span class="nx">shaderID</span> <span class="p">]</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>heuristics to create shader parameters according to lights in the scene
(not to blow over maxLights budget)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">maxLightCount</span> <span class="o">=</span> <span class="nx">allocateLights</span><span class="p">(</span> <span class="nx">lights</span> <span class="p">);</span>

		<span class="nx">maxShadows</span> <span class="o">=</span> <span class="nx">allocateShadows</span><span class="p">(</span> <span class="nx">lights</span> <span class="p">);</span>

		<span class="nx">maxBones</span> <span class="o">=</span> <span class="nx">allocateBones</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="nx">parameters</span> <span class="o">=</span> <span class="p">{</span>

			<span class="nx">map</span><span class="o">:</span> <span class="o">!!</span><span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="nx">envMap</span><span class="o">:</span> <span class="o">!!</span><span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span><span class="p">,</span> <span class="nx">lightMap</span><span class="o">:</span> <span class="o">!!</span><span class="nx">material</span><span class="p">.</span><span class="nx">lightMap</span><span class="p">,</span>
			<span class="nx">vertexColors</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">vertexColors</span><span class="p">,</span>
			<span class="nx">fog</span><span class="o">:</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">useFog</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">fog</span><span class="p">,</span>
			<span class="nx">sizeAttenuation</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">sizeAttenuation</span><span class="p">,</span>
			<span class="nx">skinning</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span><span class="p">,</span>
			<span class="nx">morphTargets</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">morphTargets</span><span class="p">,</span>
			<span class="nx">maxMorphTargets</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxMorphTargets</span><span class="p">,</span>
			<span class="nx">maxDirLights</span><span class="o">:</span> <span class="nx">maxLightCount</span><span class="p">.</span><span class="nx">directional</span><span class="p">,</span> <span class="nx">maxPointLights</span><span class="o">:</span> <span class="nx">maxLightCount</span><span class="p">.</span><span class="nx">point</span><span class="p">,</span>
			<span class="nx">maxBones</span><span class="o">:</span> <span class="nx">maxBones</span><span class="p">,</span>
			<span class="nx">shadowMapEnabled</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapEnabled</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">receiveShadow</span><span class="p">,</span>
			<span class="nx">shadowMapSoft</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapSoft</span><span class="p">,</span>
			<span class="nx">shadowMapWidth</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapWidth</span><span class="p">,</span>
			<span class="nx">shadowMapHeight</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">shadowMapHeight</span><span class="p">,</span>
			<span class="nx">maxShadows</span><span class="o">:</span> <span class="nx">maxShadows</span><span class="p">,</span>
			<span class="nx">alphaTest</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">alphaTest</span><span class="p">,</span>
			<span class="nx">metal</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">metal</span><span class="p">,</span>
			<span class="nx">perPixel</span><span class="o">:</span> <span class="nx">material</span><span class="p">.</span><span class="nx">perPixel</span>

		<span class="p">};</span>

		<span class="nx">material</span><span class="p">.</span><span class="nx">program</span> <span class="o">=</span> <span class="nx">buildProgram</span><span class="p">(</span> <span class="nx">shaderID</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">fragmentShader</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">vertexShader</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">parameters</span> <span class="p">);</span>

		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">color</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">color</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">normal</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">tangent</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">tangent</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span> <span class="o">&amp;&amp;</span>
			 <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexA</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexB</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			 <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinWeight</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexA</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinVertexB</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinIndex</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">skinWeight</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">a</span> <span class="p">]</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">morphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">numSupportedMorphTargets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">base</span> <span class="o">=</span> <span class="s2">&quot;morphTarget&quot;</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxMorphTargets</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">id</span> <span class="o">=</span> <span class="nx">base</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="p">);</span>
					<span class="nx">material</span><span class="p">.</span><span class="nx">numSupportedMorphTargets</span> <span class="o">++</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">material</span><span class="p">.</span><span class="nx">uniformsList</span> <span class="o">=</span> <span class="p">[];</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">u</span> <span class="k">in</span> <span class="nx">material</span><span class="p">.</span><span class="nx">uniforms</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">material</span><span class="p">.</span><span class="nx">uniformsList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">[</span> <span class="nx">material</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">[</span> <span class="nx">u</span> <span class="p">],</span> <span class="nx">u</span> <span class="p">]</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setMaterialShaders</span> <span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">shaders</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">material</span><span class="p">.</span><span class="nx">uniforms</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">UniformsUtils</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">shaders</span><span class="p">.</span><span class="nx">uniforms</span> <span class="p">);</span>
		<span class="nx">material</span><span class="p">.</span><span class="nx">vertexShader</span> <span class="o">=</span> <span class="nx">shaders</span><span class="p">.</span><span class="nx">vertexShader</span><span class="p">;</span>
		<span class="nx">material</span><span class="p">.</span><span class="nx">fragmentShader</span> <span class="o">=</span> <span class="nx">shaders</span><span class="p">.</span><span class="nx">fragmentShader</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setProgram</span> <span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">initMaterial</span><span class="p">(</span> <span class="nx">material</span><span class="p">,</span> <span class="nx">lights</span><span class="p">,</span> <span class="nx">fog</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">morphTargets</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">maxMorphTargets</span> <span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">maxMorphTargets</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">object</span><span class="p">.</span><span class="nx">__webglMorphTargetInfluences</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">refreshMaterial</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="kd">var</span> <span class="nx">program</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span>
			<span class="nx">p_uniforms</span> <span class="o">=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">,</span>
			<span class="nx">m_uniforms</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">program</span> <span class="o">!==</span> <span class="nx">_currentProgram</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span> <span class="nx">program</span> <span class="p">);</span>
			<span class="nx">_currentProgram</span> <span class="o">=</span> <span class="nx">program</span><span class="p">;</span>

			<span class="nx">refreshMaterial</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">_currentMaterialId</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_currentMaterialId</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
			<span class="nx">refreshMaterial</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">refreshMaterial</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">projectionMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">_projectionMatrixArray</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>refresh uniforms common to several materials</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">fog</span> <span class="o">&amp;&amp;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">fog</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsFog</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">fog</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span><span class="p">.</span><span class="nx">lights</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">setupLights</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">lights</span> <span class="p">);</span>
				<span class="nx">refreshUniformsLights</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">_lights</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsCommon</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>refresh single material specific uniforms</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LineBasicMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsLine</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleBasicMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsParticle</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsPhong</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsLambert</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshDepthMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">m_uniforms</span><span class="p">.</span><span class="nx">mNear</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">near</span><span class="p">;</span>
				<span class="nx">m_uniforms</span><span class="p">.</span><span class="nx">mFar</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">far</span><span class="p">;</span>
				<span class="nx">m_uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshNormalMaterial</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">m_uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">receiveShadow</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">material</span><span class="p">.</span><span class="nx">_shadowPass</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">refreshUniformsShadow</span><span class="p">(</span> <span class="nx">m_uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>load common uniforms</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">loadUniformsGeneric</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">uniformsList</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>load material specific uniforms
(shader material also gets them for the sake of genericity)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">cameraPosition</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3f</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">cameraPosition</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshPhongMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span> <span class="o">||</span>
				 <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">viewMatrix</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">viewMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">_viewMatrixArray</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">loadUniformsSkinning</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="nx">loadUniformsMatrices</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span> <span class="o">||</span>
			 <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span> <span class="o">||</span>
			 <span class="nx">material</span><span class="p">.</span><span class="nx">skinning</span> <span class="o">||</span>
			 <span class="nx">object</span><span class="p">.</span><span class="nx">receiveShadow</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">objectMatrix</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">p_uniforms</span><span class="p">.</span><span class="nx">objectMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_objectMatrixArray</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">program</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Uniforms (refresh uniforms objects)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">refreshUniformsCommon</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">diffuse</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">copyGammaToLinear</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">color</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">diffuse</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">texture</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">offsetRepeat</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">offset</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">repeat</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">repeat</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">lightMap</span><span class="p">.</span><span class="nx">texture</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">lightMap</span><span class="p">;</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">envMap</span><span class="p">.</span><span class="nx">texture</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">flipEnvMap</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderTargetCube</span> <span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>uniforms.reflectivity.value = material.reflectivity * material.reflectivity;</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">reflectivity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">reflectivity</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">reflectivity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">reflectivity</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">refractionRatio</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">refractionRatio</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">combine</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">combine</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">useRefract</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span> <span class="o">&amp;&amp;</span> <span class="nx">material</span><span class="p">.</span><span class="nx">envMap</span><span class="p">.</span><span class="nx">mapping</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CubeRefractionMapping</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsLine</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">diffuse</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsParticle</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">psColor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">opacity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span> <span class="c1">// TODO: Cache this.</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">texture</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsFog</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">fog</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">fogColor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">fog</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">fog</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Fog</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">fogNear</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">fog</span><span class="p">.</span><span class="nx">near</span><span class="p">;</span>
			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">fogFar</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">fog</span><span class="p">.</span><span class="nx">far</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">fog</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FogExp2</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">fogDensity</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">fog</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsPhong</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">shininess</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">shininess</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">ambient</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">copyGammaToLinear</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">ambient</span> <span class="p">);</span>
			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">specular</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">copyGammaToLinear</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">specular</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">ambient</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">ambient</span><span class="p">;</span>
			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">specular</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">specular</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsLambert</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">ambient</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">copyGammaToLinear</span><span class="p">(</span> <span class="nx">material</span><span class="p">.</span><span class="nx">ambient</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">ambient</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">material</span><span class="p">.</span><span class="nx">ambient</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsLights</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">lights</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">ambientLightColor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">ambient</span><span class="p">;</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">directionalLightColor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">directional</span><span class="p">.</span><span class="nx">colors</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">directionalLightDirection</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">directional</span><span class="p">.</span><span class="nx">positions</span><span class="p">;</span>

		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">pointLightColor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">colors</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">pointLightPosition</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">positions</span><span class="p">;</span>
		<span class="nx">uniforms</span><span class="p">.</span><span class="nx">pointLightDistance</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">distances</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">refreshUniformsShadow</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">material</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">shadowMatrix</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_shadowMatrix</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">uniforms</span><span class="p">.</span><span class="nx">shadowMatrix</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_shadowMatrix</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
				<span class="nx">uniforms</span><span class="p">.</span><span class="nx">shadowMap</span><span class="p">.</span><span class="nx">texture</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMap</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>


			<span class="p">}</span>

			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">shadowDarkness</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapDarkness</span><span class="p">;</span>
			<span class="nx">uniforms</span><span class="p">.</span><span class="nx">shadowBias</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">shadowMapBias</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Uniforms (load to GPU)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">loadUniformsSkinning</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">cameraInverseMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">_viewMatrixArray</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">boneGlobalMatrices</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">boneMatrices</span> <span class="p">);</span>

	<span class="p">};</span>


	<span class="kd">function</span> <span class="nx">loadUniformsMatrices</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">modelViewMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">normalMatrix</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix3fv</span><span class="p">(</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">normalMatrix</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_normalMatrixArray</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">loadUniformsGeneric</span> <span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">uniforms</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">uniform</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">il</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">jl</span><span class="p">,</span> <span class="nx">offset</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">jl</span> <span class="o">=</span> <span class="nx">uniforms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">jl</span><span class="p">;</span> <span class="nx">j</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">location</span> <span class="o">=</span> <span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">[</span> <span class="nx">uniforms</span><span class="p">[</span> <span class="nx">j</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">location</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

			<span class="nx">uniform</span> <span class="o">=</span> <span class="nx">uniforms</span><span class="p">[</span> <span class="nx">j</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">];</span>

			<span class="nx">type</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
			<span class="nx">value</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>single integer</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;i&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>single float</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;f&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>single THREE.Vector2</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v2&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform2f</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>single THREE.Vector3</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v3&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3f</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>single THREE.Vector4</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v4&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform4f</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">w</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>single THREE.Color</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;c&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3f</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">b</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>flat array of floats (JS or typed array)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;fv1&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1fv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>flat array of floats with 3 x N size (JS or typed array)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;fv&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3fv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>array of THREE.Vector3</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;v3v&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">offset</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">[</span> <span class="nx">offset</span> <span class="p">]</span> 	 <span class="o">=</span> <span class="nx">value</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">x</span><span class="p">;</span>
					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">y</span><span class="p">;</span>
					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">[</span> <span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">z</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform3fv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>single THREE.Matrix4</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;m4&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">value</span><span class="p">.</span><span class="nx">flattenToArray</span><span class="p">(</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>array of THREE.Matrix4</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;m4v&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">16</span> <span class="o">*</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">value</span><span class="p">[</span> <span class="nx">i</span> <span class="p">].</span><span class="nx">flattenToArrayOffset</span><span class="p">(</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">,</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>single THREE.Texture (2d or cube)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;t&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>

				<span class="nx">texture</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">texture</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">texture</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">&amp;&amp;</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">setCubeTexture</span><span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderTargetCube</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">setCubeTextureDynamic</span><span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">setTexture</span><span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>

				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>array of THREE.Texture (2d)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;tv&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="o">=</span> <span class="p">[];</span>

					<span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">texture</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

						<span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>

					<span class="p">}</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">uniform1iv</span><span class="p">(</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span> <span class="p">);</span>

				<span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">texture</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">texture</span> <span class="o">=</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">texture</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">texture</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

					<span class="nx">setTexture</span><span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">uniform</span><span class="p">.</span><span class="nx">_array</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setupMatrices</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">computeNormalMatrix</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span><span class="p">.</span><span class="nx">multiplyToArray</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorldInverse</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrixArray</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">computeNormalMatrix</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">.</span><span class="nx">makeInvert3x3</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_modelViewMatrix</span> <span class="p">).</span><span class="nx">transposeIntoArray</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_normalMatrixArray</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setupLights</span> <span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">lights</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ll</span><span class="p">,</span> <span class="nx">light</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span>
		<span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">color</span><span class="p">,</span> <span class="nx">position</span><span class="p">,</span> <span class="nx">intensity</span><span class="p">,</span> <span class="nx">distance</span><span class="p">,</span>

		<span class="nx">zlights</span> <span class="o">=</span> <span class="nx">_lights</span><span class="p">,</span>

		<span class="nx">dcolors</span> <span class="o">=</span> <span class="nx">zlights</span><span class="p">.</span><span class="nx">directional</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>
		<span class="nx">dpositions</span> <span class="o">=</span> <span class="nx">zlights</span><span class="p">.</span><span class="nx">directional</span><span class="p">.</span><span class="nx">positions</span><span class="p">,</span>

		<span class="nx">pcolors</span> <span class="o">=</span> <span class="nx">zlights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">colors</span><span class="p">,</span>
		<span class="nx">ppositions</span> <span class="o">=</span> <span class="nx">zlights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">positions</span><span class="p">,</span>
		<span class="nx">pdistances</span> <span class="o">=</span> <span class="nx">zlights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">distances</span><span class="p">,</span>

		<span class="nx">dlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">plength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="nx">doffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">poffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ll</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">ll</span><span class="p">;</span> <span class="nx">l</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">light</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">[</span> <span class="nx">l</span> <span class="p">];</span>
			<span class="nx">color</span> <span class="o">=</span> <span class="nx">light</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>

			<span class="nx">position</span> <span class="o">=</span> <span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">;</span>
			<span class="nx">intensity</span> <span class="o">=</span> <span class="nx">light</span><span class="p">.</span><span class="nx">intensity</span><span class="p">;</span>
			<span class="nx">distance</span> <span class="o">=</span> <span class="nx">light</span><span class="p">.</span><span class="nx">distance</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">AmbientLight</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">r</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
					<span class="nx">g</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
					<span class="nx">b</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">r</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
					<span class="nx">g</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">;</span>
					<span class="nx">b</span> <span class="o">+=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">DirectionalLight</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">doffset</span> <span class="o">=</span> <span class="nx">dlength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">dlength</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SpotLight</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// hack, not a proper spotlight</span>

				<span class="nx">doffset</span> <span class="o">=</span> <span class="nx">dlength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">dcolors</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">position</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>

				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>
				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>
				<span class="nx">dpositions</span><span class="p">[</span> <span class="nx">doffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>

				<span class="nx">dlength</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PointLight</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">poffset</span> <span class="o">=</span> <span class="nx">plength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">g</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>
					<span class="nx">pcolors</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">intensity</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="nx">ppositions</span><span class="p">[</span> <span class="nx">poffset</span> <span class="p">]</span>     <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
				<span class="nx">ppositions</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
				<span class="nx">ppositions</span><span class="p">[</span> <span class="nx">poffset</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

				<span class="nx">pdistances</span><span class="p">[</span> <span class="nx">plength</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">;</span>

				<span class="nx">plength</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>null eventual remains from removed lights
(this is to avoid if in shader)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">dlength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">ll</span> <span class="o">=</span> <span class="nx">dcolors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">ll</span><span class="p">;</span> <span class="nx">l</span> <span class="o">++</span> <span class="p">)</span> <span class="nx">dcolors</span><span class="p">[</span> <span class="nx">l</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">plength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">ll</span> <span class="o">=</span> <span class="nx">pcolors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">ll</span><span class="p">;</span> <span class="nx">l</span> <span class="o">++</span> <span class="p">)</span> <span class="nx">pcolors</span><span class="p">[</span> <span class="nx">l</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

		<span class="nx">zlights</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">plength</span><span class="p">;</span>
		<span class="nx">zlights</span><span class="p">.</span><span class="nx">directional</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">dlength</span><span class="p">;</span>

		<span class="nx">zlights</span><span class="p">.</span><span class="nx">ambient</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
		<span class="nx">zlights</span><span class="p">.</span><span class="nx">ambient</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">g</span><span class="p">;</span>
		<span class="nx">zlights</span><span class="p">.</span><span class="nx">ambient</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>GL state setting</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">setFaceCulling</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">cullFace</span><span class="p">,</span> <span class="nx">frontFace</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">cullFace</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">frontFace</span> <span class="o">||</span> <span class="nx">frontFace</span> <span class="o">===</span> <span class="s2">&quot;ccw&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">frontFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CCW</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">frontFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CW</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span> <span class="nx">cullFace</span> <span class="o">===</span> <span class="s2">&quot;back&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">cullFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">BACK</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">cullFace</span> <span class="o">===</span> <span class="s2">&quot;front&quot;</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">cullFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRONT</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">cullFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRONT_AND_BACK</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setLineWidth</span> <span class="p">(</span> <span class="nx">width</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">width</span> <span class="o">!==</span> <span class="nx">_oldLineWidth</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">lineWidth</span><span class="p">(</span> <span class="nx">width</span> <span class="p">);</span>

			<span class="nx">_oldLineWidth</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setObjectFaces</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_oldDoubleSided</span> <span class="o">!==</span> <span class="nx">object</span><span class="p">.</span><span class="nx">doubleSided</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">doubleSided</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_oldDoubleSided</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">doubleSided</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_oldFlipSided</span> <span class="o">!==</span> <span class="nx">object</span><span class="p">.</span><span class="nx">flipSided</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">flipSided</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">frontFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CW</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">frontFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CCW</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_oldFlipSided</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">flipSided</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setDepthTest</span> <span class="p">(</span> <span class="nx">depthTest</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_oldDepthTest</span> <span class="o">!==</span> <span class="nx">depthTest</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span> <span class="nx">depthTest</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_oldDepthTest</span> <span class="o">=</span> <span class="nx">depthTest</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setDepthWrite</span> <span class="p">(</span> <span class="nx">depthWrite</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_oldDepthWrite</span> <span class="o">!==</span> <span class="nx">depthWrite</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">depthMask</span><span class="p">(</span> <span class="nx">depthWrite</span> <span class="p">);</span>
			<span class="nx">_oldDepthWrite</span> <span class="o">=</span> <span class="nx">depthWrite</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setPolygonOffset</span> <span class="p">(</span> <span class="nx">polygonoffset</span><span class="p">,</span> <span class="nx">factor</span><span class="p">,</span> <span class="nx">units</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">_oldPolygonOffset</span> <span class="o">!==</span> <span class="nx">polygonoffset</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">polygonoffset</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">POLYGON_OFFSET_FILL</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">POLYGON_OFFSET_FILL</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_oldPolygonOffset</span> <span class="o">=</span> <span class="nx">polygonoffset</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">polygonoffset</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">_oldPolygonOffsetFactor</span> <span class="o">!==</span> <span class="nx">factor</span> <span class="o">||</span> <span class="nx">_oldPolygonOffsetUnits</span> <span class="o">!==</span> <span class="nx">units</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">polygonOffset</span><span class="p">(</span> <span class="nx">factor</span><span class="p">,</span> <span class="nx">units</span> <span class="p">);</span>

			<span class="nx">_oldPolygonOffsetFactor</span> <span class="o">=</span> <span class="nx">factor</span><span class="p">;</span>
			<span class="nx">_oldPolygonOffsetUnits</span> <span class="o">=</span> <span class="nx">units</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setBlending</span> <span class="p">(</span> <span class="nx">blending</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">blending</span> <span class="o">!==</span> <span class="nx">_oldBlending</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">switch</span> <span class="p">(</span> <span class="nx">blending</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">AdditiveBlending</span><span class="o">:</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendEquation</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendFunc</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SRC_ALPHA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE</span> <span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SubtractiveBlending</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>TODO: Find blendFuncSeparate() combination</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendEquation</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendFunc</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE_MINUS_SRC_COLOR</span> <span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MultiplyBlending</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>TODO: Find blendFuncSeparate() combination</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendEquation</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendFunc</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SRC_COLOR</span> <span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>

				<span class="k">default</span><span class="o">:</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendEquationSeparate</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span> <span class="p">);</span>
					<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendFuncSeparate</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SRC_ALPHA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE_MINUS_SRC_ALPHA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE_MINUS_SRC_ALPHA</span> <span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_oldBlending</span> <span class="o">=</span> <span class="nx">blending</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Shaders</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">buildProgram</span> <span class="p">(</span> <span class="nx">shaderID</span><span class="p">,</span> <span class="nx">fragmentShader</span><span class="p">,</span> <span class="nx">vertexShader</span><span class="p">,</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">parameters</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pl</span><span class="p">,</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">code</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Generate code</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="nx">shaderID</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">shaderID</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">fragmentShader</span> <span class="p">);</span>
			<span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">vertexShader</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">parameters</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">p</span> <span class="p">);</span>
			<span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">parameters</span><span class="p">[</span> <span class="nx">p</span> <span class="p">]</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">code</span> <span class="o">=</span> <span class="nx">chunks</span><span class="p">.</span><span class="nx">join</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Check if code has been already compiled</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span> <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">_programs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">p</span> <span class="o">&lt;</span> <span class="nx">pl</span><span class="p">;</span> <span class="nx">p</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">_programs</span><span class="p">[</span> <span class="nx">p</span> <span class="p">].</span><span class="nx">code</span> <span class="o">===</span> <span class="nx">code</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>console.log( "Code already compiled." /<em>: \n\n" + code</em>/ );</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="nx">_programs</span><span class="p">[</span> <span class="nx">p</span> <span class="p">].</span><span class="nx">program</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>console.log( "building new program " );</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">program</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createProgram</span><span class="p">();</span>

		<span class="kd">var</span> <span class="nx">prefix_vertex</span> <span class="o">=</span> <span class="p">[</span>

			<span class="nx">_supportsVertexTextures</span> <span class="o">?</span> <span class="s2">&quot;#define VERTEX_TEXTURES&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="o">?</span> <span class="s2">&quot;#define GAMMA_INPUT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">gammaOutput</span> <span class="o">?</span> <span class="s2">&quot;#define GAMMA_OUTPUT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">physicallyBasedShading</span> <span class="o">?</span> <span class="s2">&quot;#define PHYSICALLY_BASED_SHADING&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#define MAX_DIR_LIGHTS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxDirLights</span><span class="p">,</span>
			<span class="s2">&quot;#define MAX_POINT_LIGHTS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxPointLights</span><span class="p">,</span>

			<span class="s2">&quot;#define MAX_SHADOWS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxShadows</span><span class="p">,</span>

			<span class="s2">&quot;#define MAX_BONES &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxBones</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">map</span> <span class="o">?</span> <span class="s2">&quot;#define USE_MAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">envMap</span> <span class="o">?</span> <span class="s2">&quot;#define USE_ENVMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">lightMap</span> <span class="o">?</span> <span class="s2">&quot;#define USE_LIGHTMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">vertexColors</span> <span class="o">?</span> <span class="s2">&quot;#define USE_COLOR&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">skinning</span> <span class="o">?</span> <span class="s2">&quot;#define USE_SKINNING&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">morphTargets</span> <span class="o">?</span> <span class="s2">&quot;#define USE_MORPHTARGETS&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">perPixel</span> <span class="o">?</span> <span class="s2">&quot;#define PHONG_PER_PIXEL&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapEnabled</span> <span class="o">?</span> <span class="s2">&quot;#define USE_SHADOWMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapSoft</span> <span class="o">?</span> <span class="s2">&quot;#define SHADOWMAP_SOFT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">sizeAttenuation</span> <span class="o">?</span> <span class="s2">&quot;#define USE_SIZEATTENUATION&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;uniform mat4 objectMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform mat4 modelViewMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform mat4 projectionMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform mat4 viewMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform mat3 normalMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform vec3 cameraPosition;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;uniform mat4 cameraInverseMatrix;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;attribute vec3 position;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;attribute vec3 normal;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;attribute vec2 uv;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;attribute vec2 uv2;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#ifdef USE_COLOR&quot;</span><span class="p">,</span>

				<span class="s2">&quot;attribute vec3 color;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#endif&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#ifdef USE_MORPHTARGETS&quot;</span><span class="p">,</span>

				<span class="s2">&quot;attribute vec3 morphTarget0;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget1;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget2;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget3;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget4;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget5;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget6;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec3 morphTarget7;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#endif&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#ifdef USE_SKINNING&quot;</span><span class="p">,</span>

				<span class="s2">&quot;attribute vec4 skinVertexA;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec4 skinVertexB;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec4 skinIndex;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;attribute vec4 skinWeight;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#endif&quot;</span><span class="p">,</span>

			<span class="s2">&quot;&quot;</span>

		<span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

		<span class="kd">var</span> <span class="nx">prefix_fragment</span> <span class="o">=</span> <span class="p">[</span>

			<span class="s2">&quot;#ifdef GL_ES&quot;</span><span class="p">,</span>
			<span class="s2">&quot;precision &quot;</span> <span class="o">+</span> <span class="nx">_precision</span> <span class="o">+</span> <span class="s2">&quot; float;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;#endif&quot;</span><span class="p">,</span>

			<span class="s2">&quot;#define MAX_DIR_LIGHTS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxDirLights</span><span class="p">,</span>
			<span class="s2">&quot;#define MAX_POINT_LIGHTS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxPointLights</span><span class="p">,</span>

			<span class="s2">&quot;#define MAX_SHADOWS &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxShadows</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">alphaTest</span> <span class="o">?</span> <span class="s2">&quot;#define ALPHATEST &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">alphaTest</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">_this</span><span class="p">.</span><span class="nx">gammaInput</span> <span class="o">?</span> <span class="s2">&quot;#define GAMMA_INPUT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">gammaOutput</span> <span class="o">?</span> <span class="s2">&quot;#define GAMMA_OUTPUT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">_this</span><span class="p">.</span><span class="nx">physicallyBasedShading</span> <span class="o">?</span> <span class="s2">&quot;#define PHYSICALLY_BASED_SHADING&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">useFog</span> <span class="o">&amp;&amp;</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">fog</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;#define USE_FOG&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">useFog</span> <span class="o">&amp;&amp;</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">fog</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FogExp2</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;#define FOG_EXP2&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">map</span> <span class="o">?</span> <span class="s2">&quot;#define USE_MAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">envMap</span> <span class="o">?</span> <span class="s2">&quot;#define USE_ENVMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">lightMap</span> <span class="o">?</span> <span class="s2">&quot;#define USE_LIGHTMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">vertexColors</span> <span class="o">?</span> <span class="s2">&quot;#define USE_COLOR&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">metal</span> <span class="o">?</span> <span class="s2">&quot;#define METAL&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">perPixel</span> <span class="o">?</span> <span class="s2">&quot;#define PHONG_PER_PIXEL&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapEnabled</span> <span class="o">?</span> <span class="s2">&quot;#define USE_SHADOWMAP&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapSoft</span> <span class="o">?</span> <span class="s2">&quot;#define SHADOWMAP_SOFT&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapSoft</span> <span class="o">?</span> <span class="s2">&quot;#define SHADOWMAP_WIDTH &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapWidth</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
			<span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapSoft</span> <span class="o">?</span> <span class="s2">&quot;#define SHADOWMAP_HEIGHT &quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">shadowMapHeight</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

			<span class="s2">&quot;uniform mat4 viewMatrix;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;uniform vec3 cameraPosition;&quot;</span><span class="p">,</span>
			<span class="s2">&quot;&quot;</span>

		<span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">getShader</span><span class="p">(</span> <span class="s2">&quot;fragment&quot;</span><span class="p">,</span> <span class="nx">prefix_fragment</span> <span class="o">+</span> <span class="nx">fragmentShader</span> <span class="p">)</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">getShader</span><span class="p">(</span> <span class="s2">&quot;vertex&quot;</span><span class="p">,</span> <span class="nx">prefix_vertex</span> <span class="o">+</span> <span class="nx">vertexShader</span> <span class="p">)</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">linkProgram</span><span class="p">(</span> <span class="nx">program</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_gl</span><span class="p">.</span><span class="nx">getProgramParameter</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINK_STATUS</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="s2">&quot;Could not initialise shader\n&quot;</span> <span class="o">+</span> <span class="s2">&quot;VALIDATE_STATUS: &quot;</span> <span class="o">+</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getProgramParameter</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">VALIDATE_STATUS</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, gl error [&quot;</span> <span class="o">+</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getError</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="p">);</span>

		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>console.log( prefix<em>fragment + fragmentShader );
console.log( prefix</em>vertex + vertexShader );</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>

		<span class="kd">var</span> <span class="nx">identifiers</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>cache uniform locations</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span>

			<span class="s1">&#39;viewMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;modelViewMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;projectionMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;normalMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;objectMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;cameraPosition&#39;</span><span class="p">,</span>
			<span class="s1">&#39;cameraInverseMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;boneGlobalMatrices&#39;</span><span class="p">,</span> <span class="s1">&#39;morphTargetInfluences&#39;</span>

		<span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">u</span> <span class="k">in</span> <span class="nx">uniforms</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">identifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">u</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">cacheUniformLocations</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">identifiers</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>cache attributes locations</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[</span>

			<span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;uv&quot;</span><span class="p">,</span> <span class="s2">&quot;uv2&quot;</span><span class="p">,</span> <span class="s2">&quot;tangent&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span>
			<span class="s2">&quot;skinVertexA&quot;</span><span class="p">,</span> <span class="s2">&quot;skinVertexB&quot;</span><span class="p">,</span> <span class="s2">&quot;skinIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;skinWeight&quot;</span>

		<span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">maxMorphTargets</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">identifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="s2">&quot;morphTarget&quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">identifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">cacheAttributeLocations</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">identifiers</span> <span class="p">);</span>

		<span class="nx">program</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">_programs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="nx">_programs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="nx">program</span><span class="o">:</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">code</span><span class="o">:</span> <span class="nx">code</span> <span class="p">}</span> <span class="p">);</span>

		<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">programs</span> <span class="o">=</span> <span class="nx">_programs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="k">return</span> <span class="nx">program</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Shader parameters cache</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">cacheUniformLocations</span> <span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">identifiers</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">id</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">id</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">program</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">id</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">cacheAttributeLocations</span> <span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">identifiers</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">id</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">id</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
			<span class="nx">program</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span> <span class="nx">program</span><span class="p">,</span> <span class="nx">id</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">getShader</span> <span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">string</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">shader</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;fragment&quot;</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shader</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAGMENT_SHADER</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;vertex&quot;</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">shader</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">VERTEX_SHADER</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">shaderSource</span><span class="p">(</span> <span class="nx">shader</span><span class="p">,</span> <span class="nx">string</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">compileShader</span><span class="p">(</span> <span class="nx">shader</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_gl</span><span class="p">.</span><span class="nx">getShaderParameter</span><span class="p">(</span> <span class="nx">shader</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">COMPILE_STATUS</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getShaderInfoLog</span><span class="p">(</span> <span class="nx">shader</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">string</span> <span class="p">);</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">shader</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Textures</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">setTextureParameters</span> <span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">image</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">isPowerOfTwo</span><span class="p">(</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isPowerOfTwo</span><span class="p">(</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_WRAP_S</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">wrapS</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_WRAP_T</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">wrapT</span> <span class="p">)</span> <span class="p">);</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_MAG_FILTER</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">magFilter</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_MIN_FILTER</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">minFilter</span> <span class="p">)</span> <span class="p">);</span>

			<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_WRAP_S</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CLAMP_TO_EDGE</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_WRAP_T</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CLAMP_TO_EDGE</span> <span class="p">);</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_MAG_FILTER</span><span class="p">,</span> <span class="nx">filterFallback</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">magFilter</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">texParameteri</span><span class="p">(</span> <span class="nx">textureType</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_MIN_FILTER</span><span class="p">,</span> <span class="nx">filterFallback</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">minFilter</span> <span class="p">)</span> <span class="p">);</span>

			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setTexture</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">slot</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">texture</span><span class="p">.</span><span class="nx">__webglInit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="nx">texture</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">();</span>

				<span class="nx">_this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">textures</span> <span class="o">++</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="o">+</span> <span class="nx">slot</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">needsMipMaps</span> <span class="o">=</span> <span class="nx">setTextureParameters</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">DataTexture</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">texImage2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">data</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">texImage2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">needsMipMaps</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">generateMipmap</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">texture</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">onUpdated</span> <span class="p">)</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">onUpdated</span><span class="p">();</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="o">+</span> <span class="nx">slot</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setCubeTexture</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">slot</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">__webglTextureCube</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">__webglTextureCube</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">();</span>

				<span class="p">}</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="o">+</span> <span class="nx">slot</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">__webglTextureCube</span> <span class="p">);</span>

				<span class="kd">var</span> <span class="nx">needsMipMaps</span> <span class="o">=</span> <span class="nx">setTextureParameters</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">texImage2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP_POSITIVE_X</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span> <span class="nx">needsMipMaps</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">generateMipmap</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span> <span class="p">);</span>

				<span class="p">}</span>

				<span class="nx">texture</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="o">+</span> <span class="nx">slot</span> <span class="p">);</span>
				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">__webglTextureCube</span> <span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setCubeTextureDynamic</span> <span class="p">(</span> <span class="nx">texture</span><span class="p">,</span> <span class="nx">slot</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE0</span> <span class="o">+</span> <span class="nx">slot</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">texture</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Render targets</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">setupFrameBuffer</span> <span class="p">(</span> <span class="nx">framebuffer</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">textureTarget</span> <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindFramebuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">framebuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">framebufferTexture2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">COLOR_ATTACHMENT0</span><span class="p">,</span> <span class="nx">textureTarget</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setupRenderBuffer</span> <span class="p">(</span> <span class="nx">renderbuffer</span><span class="p">,</span> <span class="nx">renderTarget</span>  <span class="p">)</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindRenderbuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">renderbuffer</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">depthBuffer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">stencilBuffer</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">renderbufferStorage</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_COMPONENT16</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">framebufferRenderbuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_ATTACHMENT</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">renderbuffer</span> <span class="p">);</span>

		<span class="cm">/* For some reason this is not working. Defaulting to RGBA4.</span>
<span class="cm">		} else if( ! renderTarget.depthBuffer &amp;&amp; renderTarget.stencilBuffer ) {</span>

<span class="cm">			_gl.renderbufferStorage( _gl.RENDERBUFFER, _gl.STENCIL_INDEX8, renderTarget.width, renderTarget.height );</span>
<span class="cm">			_gl.framebufferRenderbuffer( _gl.FRAMEBUFFER, _gl.STENCIL_ATTACHMENT, _gl.RENDERBUFFER, renderbuffer );</span>
<span class="cm">		*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">depthBuffer</span> <span class="o">&amp;&amp;</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">stencilBuffer</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">renderbufferStorage</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_STENCIL</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">framebufferRenderbuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_STENCIL_ATTACHMENT</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">renderbuffer</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">renderbufferStorage</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA4</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setRenderTarget</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">isCube</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderTargetCube</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">depthBuffer</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">depthBuffer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">stencilBuffer</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">stencilBuffer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

			<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Setup texture, create render and frame buffers</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">isCube</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span> <span class="o">=</span> <span class="p">[];</span>
				<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglRenderbuffer</span> <span class="o">=</span> <span class="p">[];</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>
				<span class="nx">setTextureParameters</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">renderTarget</span> <span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

					<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createFramebuffer</span><span class="p">();</span>
					<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglRenderbuffer</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createRenderbuffer</span><span class="p">();</span>

					<span class="nx">_gl</span><span class="p">.</span><span class="nx">texImage2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP_POSITIVE_X</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">type</span> <span class="p">),</span> <span class="kc">null</span> <span class="p">);</span>

					<span class="nx">setupFrameBuffer</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP_POSITIVE_X</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">);</span>
					<span class="nx">setupRenderBuffer</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglRenderbuffer</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="nx">renderTarget</span> <span class="p">);</span>

				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createFramebuffer</span><span class="p">();</span>
				<span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglRenderbuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createRenderbuffer</span><span class="p">();</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>
				<span class="nx">setTextureParameters</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">renderTarget</span> <span class="p">);</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">texImage2D</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">format</span> <span class="p">),</span> <span class="nx">paramThreeToGL</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">type</span> <span class="p">),</span> <span class="kc">null</span> <span class="p">);</span>

				<span class="nx">setupFrameBuffer</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span> <span class="p">);</span>
				<span class="nx">setupRenderBuffer</span><span class="p">(</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglRenderbuffer</span><span class="p">,</span> <span class="nx">renderTarget</span> <span class="p">);</span>

			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Release everything</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span> <span class="nx">isCube</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>

			<span class="p">}</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindRenderbuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RENDERBUFFER</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindFramebuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">framebuffer</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">vx</span><span class="p">,</span> <span class="nx">vy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">isCube</span> <span class="p">)</span> <span class="p">{</span>

				<span class="nx">framebuffer</span> <span class="o">=</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span><span class="p">[</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">activeCubeFace</span> <span class="p">];</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="nx">framebuffer</span> <span class="o">=</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglFramebuffer</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">width</span> <span class="o">=</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
			<span class="nx">height</span> <span class="o">=</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

			<span class="nx">vx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nx">vy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">framebuffer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

			<span class="nx">width</span> <span class="o">=</span> <span class="nx">_viewportWidth</span><span class="p">;</span>
			<span class="nx">height</span> <span class="o">=</span> <span class="nx">_viewportHeight</span><span class="p">;</span>

			<span class="nx">vx</span> <span class="o">=</span> <span class="nx">_viewportX</span><span class="p">;</span>
			<span class="nx">vy</span> <span class="o">=</span> <span class="nx">_viewportY</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">framebuffer</span> <span class="o">!==</span> <span class="nx">_currentFramebuffer</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindFramebuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">framebuffer</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">viewport</span><span class="p">(</span> <span class="nx">vx</span><span class="p">,</span> <span class="nx">vy</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">);</span>

			<span class="nx">_currentFramebuffer</span> <span class="o">=</span> <span class="nx">framebuffer</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">updateRenderTargetMipmap</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">renderTarget</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderTargetCube</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">generateMipmap</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_CUBE_MAP</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="nx">renderTarget</span><span class="p">.</span><span class="nx">__webglTexture</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">generateMipmap</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span> <span class="p">);</span>
			<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>

		<span class="p">}</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>fallback filters for non-power-of-2 textures</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">filterFallback</span> <span class="p">(</span> <span class="nx">f</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span> <span class="nx">f</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestFilter</span><span class="o">:</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestMipMapNearestFilter</span><span class="o">:</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestMipMapLinearFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">NEAREST</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearFilter</span><span class="o">:</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapNearestFilter</span><span class="o">:</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapLinearFilter</span><span class="o">:</span>
			<span class="k">default</span><span class="o">:</span>

				<span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINEAR</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">paramThreeToGL</span> <span class="p">(</span> <span class="nx">p</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span> <span class="nx">p</span> <span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">RepeatWrapping</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">REPEAT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ClampToEdgeWrapping</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CLAMP_TO_EDGE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MirroredRepeatWrapping</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">MIRRORED_REPEAT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">NEAREST</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestMipMapNearestFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">NEAREST_MIPMAP_NEAREST</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">NearestMipMapLinearFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">NEAREST_MIPMAP_LINEAR</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINEAR</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapNearestFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINEAR_MIPMAP_NEAREST</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LinearMipMapLinearFilter</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LINEAR_MIPMAP_LINEAR</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ByteType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">BYTE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">UnsignedByteType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShortType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SHORT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">UnsignedShortType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">IntType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">INT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">UnsignedShortType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">UNSIGNED_INT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FloatType</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">AlphaFormat</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ALPHA</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">RGBFormat</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGB</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">RGBAFormat</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LuminanceFormat</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LUMINANCE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LuminanceAlphaFormat</span><span class="o">:</span> <span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LUMINANCE_ALPHA</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">isPowerOfTwo</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">return</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Allocations</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">allocateBones</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>default for when object is not specified
( for example when prebuilding shader
  to be used with multiple objects )</p>

<pre><code>- leave some extra space for other uniforms
</code></pre>

<p>- limit here is ANGLE's 254 max uniform vectors
   (up to 54 should be safe)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">maxBones</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SkinnedMesh</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">maxBones</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">bones</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">maxBones</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">allocateLights</span> <span class="p">(</span> <span class="nx">lights</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ll</span><span class="p">,</span> <span class="nx">light</span><span class="p">,</span> <span class="nx">dirLights</span><span class="p">,</span> <span class="nx">pointLights</span><span class="p">,</span> <span class="nx">maxDirLights</span><span class="p">,</span> <span class="nx">maxPointLights</span><span class="p">;</span>
		<span class="nx">dirLights</span> <span class="o">=</span> <span class="nx">pointLights</span> <span class="o">=</span> <span class="nx">maxDirLights</span> <span class="o">=</span> <span class="nx">maxPointLights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ll</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">ll</span><span class="p">;</span> <span class="nx">l</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">light</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">[</span> <span class="nx">l</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SpotLight</span> <span class="p">)</span> <span class="nx">dirLights</span> <span class="o">++</span><span class="p">;</span> <span class="c1">// hack, not a proper spotlight</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">DirectionalLight</span> <span class="p">)</span> <span class="nx">dirLights</span> <span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PointLight</span> <span class="p">)</span> <span class="nx">pointLights</span> <span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">pointLights</span> <span class="o">+</span> <span class="nx">dirLights</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">_maxLights</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">maxDirLights</span> <span class="o">=</span> <span class="nx">dirLights</span><span class="p">;</span>
			<span class="nx">maxPointLights</span> <span class="o">=</span> <span class="nx">pointLights</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="nx">maxDirLights</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span> <span class="nx">_maxLights</span> <span class="o">*</span> <span class="nx">dirLights</span> <span class="o">/</span> <span class="p">(</span> <span class="nx">pointLights</span> <span class="o">+</span> <span class="nx">dirLights</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">maxPointLights</span> <span class="o">=</span> <span class="nx">_maxLights</span> <span class="o">-</span> <span class="nx">maxDirLights</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;directional&#39;</span> <span class="o">:</span> <span class="nx">maxDirLights</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span> <span class="o">:</span> <span class="nx">maxPointLights</span> <span class="p">};</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">allocateShadows</span> <span class="p">(</span> <span class="nx">lights</span> <span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ll</span><span class="p">,</span> <span class="nx">light</span><span class="p">,</span> <span class="nx">maxShadows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ll</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">ll</span><span class="p">;</span> <span class="nx">l</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">light</span> <span class="o">=</span> <span class="nx">lights</span><span class="p">[</span> <span class="nx">l</span> <span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span> <span class="nx">light</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">SpotLight</span> <span class="o">&amp;&amp;</span> <span class="nx">light</span><span class="p">.</span><span class="nx">castShadow</span> <span class="p">)</span> <span class="nx">maxShadows</span> <span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">maxShadows</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">maxVertexTextures</span> <span class="p">()</span> <span class="p">{</span>

		<span class="k">return</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">MAX_VERTEX_TEXTURE_IMAGE_UNITS</span> <span class="p">);</span>

	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Initialization</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">function</span> <span class="nx">initSprites</span> <span class="p">()</span> <span class="p">{</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span>    <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span> <span class="mi">6</span> <span class="p">);</span>

		<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// vertex 0</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// uv 0</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// vertex 1</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// uv 1</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// vertex 2</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// uv 2</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// vertex 3</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// uv 3</span>

		<span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertexBuffer</span>  <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">elementBuffer</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertexBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">vertices</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">STATIC_DRAW</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">elementBuffer</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ELEMENT_ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">faces</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">STATIC_DRAW</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">createProgram</span><span class="p">();</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">getShader</span><span class="p">(</span> <span class="s2">&quot;fragment&quot;</span><span class="p">,</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderLib</span><span class="p">.</span><span class="nx">sprite</span><span class="p">.</span><span class="nx">fragmentShader</span> <span class="p">)</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="nx">getShader</span><span class="p">(</span> <span class="s2">&quot;vertex&quot;</span><span class="p">,</span>   <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderLib</span><span class="p">.</span><span class="nx">sprite</span><span class="p">.</span><span class="nx">vertexShader</span>   <span class="p">)</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">linkProgram</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span> <span class="o">=</span> <span class="p">{};</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">position</span>           <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getAttribLocation</span> <span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">uv</span>                 <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getAttribLocation</span> <span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;uv&quot;</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">uvOffset</span>             <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;uvOffset&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">uvScale</span>              <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;uvScale&quot;</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">rotation</span>             <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;rotation&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">scale</span>                <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">alignment</span>            <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;alignment&quot;</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">color</span>                <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">map</span>                  <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">opacity</span>              <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span> <span class="p">);</span>

		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">useScreenCoordinates</span> <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;useScreenCoordinates&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">affectedByDistance</span>   <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;affectedByDistance&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">screenPosition</span>    	  <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;screenPosition&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">modelViewMatrix</span>      <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;modelViewMatrix&quot;</span> <span class="p">);</span>
		<span class="nx">_sprite</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">projectionMatrix</span>     <span class="o">=</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span> <span class="nx">_sprite</span><span class="p">.</span><span class="nx">program</span><span class="p">,</span> <span class="s2">&quot;projectionMatrix&quot;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>_gl.enableVertexAttribArray( _sprite.attributes.position );
_gl.enableVertexAttribArray( _sprite.attributes.uv );</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">initShadowmaps</span> <span class="p">()</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">depthShader</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderLib</span><span class="p">[</span> <span class="s2">&quot;depthRGBA&quot;</span> <span class="p">];</span>
		<span class="kd">var</span> <span class="nx">depthUniforms</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">UniformsUtils</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">depthShader</span><span class="p">.</span><span class="nx">uniforms</span> <span class="p">);</span>

		<span class="nx">_depthMaterial</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">fragmentShader</span><span class="o">:</span> <span class="nx">depthShader</span><span class="p">.</span><span class="nx">fragmentShader</span><span class="p">,</span> <span class="nx">vertexShader</span><span class="o">:</span> <span class="nx">depthShader</span><span class="p">.</span><span class="nx">vertexShader</span><span class="p">,</span> <span class="nx">uniforms</span><span class="o">:</span> <span class="nx">depthUniforms</span> <span class="p">}</span> <span class="p">);</span>
		<span class="nx">_depthMaterialMorph</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">fragmentShader</span><span class="o">:</span> <span class="nx">depthShader</span><span class="p">.</span><span class="nx">fragmentShader</span><span class="p">,</span> <span class="nx">vertexShader</span><span class="o">:</span> <span class="nx">depthShader</span><span class="p">.</span><span class="nx">vertexShader</span><span class="p">,</span> <span class="nx">uniforms</span><span class="o">:</span> <span class="nx">depthUniforms</span><span class="p">,</span> <span class="nx">morphTargets</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>

		<span class="nx">_depthMaterial</span><span class="p">.</span><span class="nx">_shadowPass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="nx">_depthMaterialMorph</span><span class="p">.</span><span class="nx">_shadowPass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="kd">function</span> <span class="nx">initGL</span> <span class="p">()</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">gl</span><span class="p">;</span>

		<span class="k">try</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="nx">gl</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span> <span class="s1">&#39;experimental-webgl&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">antialias</span><span class="o">:</span> <span class="nx">_antialias</span><span class="p">,</span> <span class="nx">stencil</span><span class="o">:</span> <span class="nx">_stencil</span><span class="p">,</span> <span class="nx">preserveDrawingBuffer</span><span class="o">:</span> <span class="nx">_preserveDrawingBuffer</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

				<span class="k">throw</span> <span class="s1">&#39;Error creating WebGL context.&#39;</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
				<span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span> <span class="o">+</span>
				<span class="nx">gl</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">VERSION</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span> <span class="o">+</span>
				<span class="nx">gl</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">VENDOR</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span> <span class="o">+</span>
				<span class="nx">gl</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RENDERER</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span> <span class="o">+</span>
				<span class="nx">gl</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">SHADING_LANGUAGE_VERSION</span> <span class="p">)</span>
			<span class="p">);</span>

		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="p">{</span>

			<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">error</span> <span class="p">);</span>

		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">gl</span><span class="p">;</span>

	<span class="p">};</span>

	<span class="kd">function</span> <span class="nx">setDefaultGLState</span> <span class="p">()</span> <span class="p">{</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearDepth</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearStencil</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">depthFunc</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">LEQUAL</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">frontFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CCW</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">cullFace</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">BACK</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">CULL_FACE</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">BLEND</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendEquation</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">FUNC_ADD</span> <span class="p">);</span>
		<span class="nx">_gl</span><span class="p">.</span><span class="nx">blendFunc</span><span class="p">(</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">SRC_ALPHA</span><span class="p">,</span> <span class="nx">_gl</span><span class="p">.</span><span class="nx">ONE_MINUS_SRC_ALPHA</span> <span class="p">);</span>

		<span class="nx">_gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">_clearColor</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nx">_clearAlpha</span> <span class="p">);</span>

	<span class="p">};</span>

<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 